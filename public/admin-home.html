<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - TradeConnect</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root {
      --primary: #4a6fa5;
      --secondary: #166088;
      --accent: #d16644;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --white: #ffffff;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Times New Roman", Times, serif;
    }

    body {
      background-color: var(--light);
      color: var(--dark);
      overflow-x: hidden;
      line-height: 1.6;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: "Times New Roman", Times, serif;
      font-weight: bold;
      color: var(--secondary);
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      transition: all 0.3s ease;
      z-index: 100;
      color: white;
    }

    .logo {
      display: flex;
      align-items: center;
      padding: 0 10px;
      margin-left: 18px;
    }
    .logo img {
      width: 20px;
      margin-right: 25px;
      animation: spinAndScale 3s linear infinite;
    }

    .logo {
      width: 40px;
      height: 40px;
      background-color: white;
      border-radius: 50%;
    }

    .logo-text {
      font-size: 14px;
      color: white;
      font-weight: bold;
    }

    @keyframes spinAndScale {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.1); }
      100% { transform: rotate(360deg) scale(1); }
    }

    .nav-menu {
      padding: 0 10px;
    }

    .nav-item {
      list-style: none;
      margin-bottom: 20px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      transition: all 0.2s ease;
    }

    .nav-link:hover, .nav-link.active {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .nav-link i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    .main-content {
      flex: 1;
      margin-left: 250px;
      padding: 20px;
      transition: margin-left 0.3s ease;
    }

    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--white);
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

     .top-nav-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .notifications {
      position: relative;
      cursor: pointer;
    }
    
    .notification-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--danger);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      display: none;
    }
    
    .notification-dropdown {
      position: absolute;
      right: 0;
      top: 40px;
      width: 300px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      display: none;
    }
    
    .notifications:hover .notification-dropdown {
      display: block;
    }
    
    .notification-header {
      padding: 10px 15px;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
    }
    
    .notification-header h4 {
      margin: 0;
    }
    
    .mark-all-read {
      font-size: 12px;
      color: var(--primary);
      cursor: pointer;
    }
    
    .notification-list {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .notification-item {
      padding: 10px 15px;
      border-bottom: 1px solid var(--light-gray);
      cursor: pointer;
    }
    
    .notification-item.unread {
      background-color: rgba(74, 111, 165, 0.05);
    }
    
    .notification-content {
      margin-bottom: 5px;
    }
    
    .notification-time {
      font-size: 12px;
      color: var(--gray);
    }

    .user-profile {
      display: flex;
      align-items: center;
      position: relative;
    }

    .user-profile img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
      border: 2px solid var(--light-gray);
    }

    .user-info {
      text-align: right;
    }

    .user-info .name {
      font-weight: bold;
      font-size: 14px;
    }

    .user-info .role {
      font-size: 12px;
      color: var(--gray);
    }
    /* Profile Dropdown Styles */
    .profile-dropdown {
      position: absolute;
      right: 0;
      top: 50px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 180px;
      z-index: 1000;
      display: none;
    }
    
    .user-profile:hover .profile-dropdown {
      display: block;
    }
    
    .dropdown-item {
      display: block;
      padding: 10px 15px;
      color: var(--dark);
      text-decoration: none;
    }
    
    .dropdown-item:hover {
      background-color: var(--light-gray);
    }
    
    .dropdown-item i {
      margin-right: 8px;
      width: 18px;
      text-align: center;
    }
    
    /* Date Format Fix in Reports */
    .report-meta {
      white-space: nowrap;
    }

    .content-section {
      display: none;
      padding: 15px;
      animation: fadeIn 0.3s ease;
    }

    .content-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Dashboard Cards */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: var(--white);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .card-icon.users {
      background-color: var(--primary);
    }

    .card-icon.sales {
      background-color: var(--success);
    }

    .card-icon.trades {
      background-color: var(--warning);
    }

    .card-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .card-label {
      font-size: 14px;
      color: var(--gray);
    }

    /* Map Container */
    .map-container {
      height: 400px;
      background: var(--white);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    #monitoringMap {
      width: 100%;
      height: 100%;
    }

    .location-info {
      text-align: right;
      font-size: 14px;
      color: var(--gray);
    }

    /* Users Table */
    .users-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .users-table th, .users-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--light-gray);
    }

    .users-table th {
      background-color: var(--primary);
      color: white;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
    }

    .users-table th.sort-asc::after {
      content: " ↑";
      font-size: 12px;
    }

    .users-table th.sort-desc::after {
      content: " ↓";
      font-size: 12px;
    }

    .users-table tr:hover {
      background-color: var(--light-gray);
    }

    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-badge.active {
      background-color: rgba(40, 167, 69, 0.1);
      color: var(--success);
    }

    .status-badge.inactive {
      background-color: rgba(220, 53, 69, 0.1);
      color: var(--danger);
    }

    /* Location Section */
    .location-section {
      display: flex;
      gap: 20px;
    }

    .zone-selector {
      width: 200px;
      background: var(--white);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .zone-selector h3 {
      margin-bottom: 15px;
      font-size: 16px;
    }

    .zone-list {
      list-style: none;
      max-height: 500px;
      overflow-y: auto;
    }

    .zone-item {
      padding: 10px;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.2s ease;
    }

    .zone-item:hover, .zone-item.active {
      background-color: var(--light-gray);
    }

    .zone-map {
      flex: 1;
      background: var(--white);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    #zoneMap {
      width: 100%;
      height: 400px;
    }

    .zone-stats {
      padding: 15px;
      font-size: 14px;
    }

    /* Reports Section */
    .reports-container {
      background: var(--white);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .report-filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .report-filters select, .report-filters input {
      padding: 10px 15px;
      border: 1px solid var(--light-gray);
      border-radius: 5px;
      font-family: "Times New Roman", Times, serif;
      min-width: 180px;
    }

    .report-filters button {
      padding: 10px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .report-list {
      list-style: none;
    }

    .report-item {
      padding: 15px;
      border-bottom: 1px solid var(--light-gray);
    }

    .report-item:last-child {
      border-bottom: none;
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .report-title {
      font-weight: bold;
    }

    .report-meta {
      font-size: 12px;
      color: var(--gray);
    }

    .report-content {
      margin-bottom: 10px;
    }

    .report-actions {
      display: flex;
      gap: 10px;
    }

    .report-actions button {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }

    .report-actions .resolve-btn {
      background-color: var(--success);
      color: white;
    }

    .report-actions .delete-btn {
      background-color: var(--danger);
      color: white;
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1100;
    }

    .toast {
      padding: 15px 20px;
      background: var(--white);
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--warning);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Confirmation Dialog */
    .confirmation-dialog {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1200;
      display: none;
    }

    .dialog-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 100%;
    }

    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    /* Responsive Styles */
    @media (max-width: 992px) {
      .dashboard-cards {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .location-section {
        flex-direction: column;
      }
      
      .zone-selector {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 70px;
        overflow: hidden;
      }
      
      .sidebar .logo-text,
      .sidebar .nav-link span {
        display: none;
      }
      
      .sidebar .logo {
        justify-content: center;
        padding: 10px;
      }
      
      .sidebar .nav-link {
        justify-content: center;
        padding: 15px 0;
      }
      
      .sidebar .nav-link i {
        margin-right: 0;
      }
      
      .main-content {
        margin-left: 70px;
      }
      
      .dashboard-cards {
        grid-template-columns: 1fr;
      }

      .report-filters {
        flex-direction: column;
      }
    }

    @media (max-width: 576px) {
      .top-nav {
        flex-direction: column;
        gap: 15px;
      }
      
      .user-profile {
        width: 100%;
        justify-content: flex-end;
      }
      
      .report-filters select, .report-filters input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar Navigation -->
    <div class="sidebar">
      <div class="logo">
        <img src="logo.png" alt="TradeConnect Logo">
        <span class="logo-text">TradeConnect</span>
      </div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link active" data-target="home">
            <i class="fas fa-home"></i>
            <span>Home</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-target="users">
            <i class="fas fa-users"></i>
            <span>Users</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-target="location">
            <i class="fas fa-map-marker-alt"></i>
            <span>Location</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-target="reports">
            <i class="fas fa-flag"></i>
            <span>Reports</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Top Navigation -->
      <div class="top-nav">
        <h2>Admin Dashboard</h2>
        <div class="top-nav-right">
          <div class="notifications">
            <i class="fas fa-bell"></i>
            <span class="notification-count">0</span>
            <div class="notification-dropdown">
              <div class="notification-header">
                <h4>Notifications</h4>
                <span class="mark-all-read">Mark all as read</span>
              </div>
              <div class="notification-list">
                <!-- Notifications will be populated here -->
              </div>
            </div>
          </div>
          <div class="user-profile">
            <img src="admin-avatar.jpg" alt="Admin Profile">
            <div class="user-info">
              <div class="name">Admin User</div>
              <div class="role">Barangay Bulihan</div>
            </div>
            <div class="profile-dropdown">
              <a href="#" class="dropdown-item"><i class="fas fa-cog"></i> Settings</a>
              <a href="#" id="logout-btn" class="dropdown-item"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Home Section -->
      <div id="home" class="content-section active">
        <div class="dashboard-cards">
          <div class="card">
            <div class="card-header">
              <h3>Active Users</h3>
              <div class="card-icon users">
                <i class="fas fa-user-check"></i>
              </div>
            </div>
            <div class="card-value" id="active-users-count">0</div>
            <div class="card-label">Currently online</div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3>Total Users</h3>
              <div class="card-icon users">
                <i class="fas fa-users"></i>
              </div>
            </div>
            <div class="card-value" id="total-users-count">0</div>
            <div class="card-label">Registered users</div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3>Best Selling Item</h3>
              <div class="card-icon sales">
                <i class="fas fa-shopping-bag"></i>
              </div>
            </div>
            <div class="card-value" id="best-selling-item">-</div>
            <div class="card-label">This month</div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3>Best Trade Item</h3>
              <div class="card-icon trades">
                <i class="fas fa-exchange-alt"></i>
              </div>
            </div>
            <div class="card-value" id="best-trade-item">-</div>
            <div class="card-label">This month</div>
          </div>
        </div>

        <div class="map-container">
          <div id="monitoringMap"></div>
        </div>
        <div class="location-info">
          Barangay Bulihan, Silang, Cavite
        </div>
      </div>

      <!-- Users Section -->
      <div id="users" class="content-section">
        <h2>User Management</h2>
        <div class="card">
          <div class="card-header">
            <h3>Total Users: <span id="users-count">0</span></h3>
            <div>
              <input type="text" id="user-search" placeholder="Search users..." style="padding: 8px 12px; border: 1px solid var(--light-gray); border-radius: 5px;">
            </div>
          </div>
          <table class="users-table">
            <thead>
              <tr>
                <th data-sort="id">ID</th>
                <th data-sort="name">Name</th>
                <th data-sort="location">Location/Zone</th>
                <th data-sort="lastActive">Last Active</th>
                <th data-sort="activity">Activity</th>
                <th data-sort="status">Status</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <tr>
                <td colspan="6" class="loading-row">
                  <div class="loading-spinner"></div> Loading users...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Location Section -->
      <div id="location" class="content-section">
        <h2>Location Management</h2>
        <div class="location-section">
          <div class="zone-selector">
            <h3>Zones</h3>
            <ul class="zone-list" id="zone-list">
              <li class="zone-item active" data-zone-id="all">All Zones</li>
              <!-- Zones will be populated here -->
            </ul>
          </div>
          <div class="zone-map">
            <div id="zoneMap"></div>
            <div class="zone-stats">
              <strong>Barangay Bulihan, Silang, Cavite</strong> | Active Users: <span id="zone-active-users">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reports" class="content-section">
        <h2>Reports Management</h2>
        <div class="reports-container">
          <div class="report-filters">
            <select id="report-type-filter">
              <option value="all">All Reports</option>
              <option value="scam">Scam Reports</option>
              <option value="item">Item Not as Described</option>
              <option value="behavior">User Behavior</option>
            </select>
            <select id="report-status-filter">
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="resolved">Resolved</option>
            </select>
            <input type="date" id="report-from-date" placeholder="From date">
            <input type="date" id="report-to-date" placeholder="To date">
            <button id="apply-filters"><i class="fas fa-filter"></i> Filter</button>
            <button id="clear-filters" style="background-color: var(--gray);">Clear</button>
          </div>
          
          <ul class="report-list" id="report-list">
            <li class="report-item loading-item">
              <div class="loading-spinner"></div> Loading reports...
            </li>
          </ul>
          
          <div class="pagination-controls" style="display: none;">
            <button id="prev-page" disabled>Previous</button>
            <span id="page-info">Page 1 of 1</span>
            <button id="next-page" disabled>Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>
  
  <!-- Confirmation Dialog -->
  <div class="confirmation-dialog" id="confirmation-dialog">
    <div class="dialog-content">
      <h3 id="dialog-title">Confirm Action</h3>
      <p id="dialog-message">Are you sure you want to perform this action?</p>
      <div class="dialog-actions">
        <button id="dialog-cancel">Cancel</button>
        <button id="dialog-confirm">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Firebase and other scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>

  <script>
    // Firebase configuration - in a real app, these should be loaded from environment variables
    const firebaseConfig = {
      apiKey: "AIzaSyCxaOGeOvHwS5dnPHRTpw3Lwn2surjXP1E",
      authDomain: "tradeconnect-3c728.firebaseapp.com",
      projectId: "tradeconnect-3c728",
      storageBucket: "tradeconnect-3c728.appspot.com",
      messagingSenderId: "299665603548",
      appId: "1:299665603548:web:9ff10af44cd41605382d19",
      databaseURL: "https://tradeconnect-3c728-default-rtdb.firebaseio.com"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // App State
    const appState = {
      currentUser: null,
      users: [],
      filteredUsers: [],
      reports: [],
      filteredReports: [],
      notifications: [],
      zones: [],
      currentZone: 'all',
      currentPage: 1,
      itemsPerPage: 10,
      sortColumn: 'lastActive',
      sortDirection: 'desc',
      activeTab: 'home',
      mapInitialized: false,
      zoneMapInitialized: false
    };

    // DOM Elements
    const elements = {
      // Navigation
      navLinks: document.querySelectorAll('.nav-link'),
      contentSections: document.querySelectorAll('.content-section'),
      logoutBtn: document.getElementById('logout-btn'),
      
      // Home Section
      activeUsersCount: document.getElementById('active-users-count'),
      totalUsersCount: document.getElementById('total-users-count'),
      bestSellingItem: document.getElementById('best-selling-item'),
      bestTradeItem: document.getElementById('best-trade-item'),
      monitoringMap: null,
      
      // Users Section
      userSearch: document.getElementById('user-search'),
      usersTableBody: document.getElementById('users-table-body'),
      usersCount: document.getElementById('users-count'),
      
      // Location Section
      zoneList: document.getElementById('zone-list'),
      zoneMap: null,
      zoneActiveUsers: document.getElementById('zone-active-users'),
      
      // Reports Section
      reportList: document.getElementById('report-list'),
      reportTypeFilter: document.getElementById('report-type-filter'),
      reportStatusFilter: document.getElementById('report-status-filter'),
      reportFromDate: document.getElementById('report-from-date'),
      reportToDate: document.getElementById('report-to-date'),
      applyFilters: document.getElementById('apply-filters'),
      clearFilters: document.getElementById('clear-filters'),
      prevPage: document.getElementById('prev-page'),
      nextPage: document.getElementById('next-page'),
      pageInfo: document.getElementById('page-info'),
      
      // Notifications
      notificationList: document.querySelector('.notification-list'),
      notificationCount: document.querySelector('.notification-count'),
      markAllRead: document.querySelector('.mark-all-read'),
      
      // Toast and Dialogs
      toastContainer: document.getElementById('toast-container'),
      confirmationDialog: document.getElementById('confirmation-dialog'),
      dialogTitle: document.getElementById('dialog-title'),
      dialogMessage: document.getElementById('dialog-message'),
      dialogCancel: document.getElementById('dialog-cancel'),
      dialogConfirm: document.getElementById('dialog-confirm')
    };

    // Utility Functions
    const utils = {
      debounce: function(func, timeout = 300) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
      },
      
      showToast: function(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
          <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
          <span>${message}</span>
        `;
        elements.toastContainer.appendChild(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 5000);
      },
      
      showConfirmation: function(title, message) {
        return new Promise((resolve) => {
          elements.dialogTitle.textContent = title;
          elements.dialogMessage.textContent = message;
          elements.confirmationDialog.style.display = 'flex';
          
          elements.dialogCancel.onclick = () => {
            elements.confirmationDialog.style.display = 'none';
            resolve(false);
          };
          
          elements.dialogConfirm.onclick = () => {
            elements.confirmationDialog.style.display = 'none';
            resolve(true);
          };
        });
      },
      
      formatDate: function(timestamp) {
        return moment(timestamp).format('MMM D, YYYY h:mm A');
      },
      
      formatRelativeTime: function(timestamp) {
        return moment(timestamp).fromNow();
      }
    };

    // Firebase Data Functions
    const firebaseData = {
      fetchUsers: function() {
        const usersRef = database.ref('users');
        usersRef.on('value', (snapshot) => {
          try {
            const users = snapshot.val() || {};
            appState.users = Object.entries(users).map(([id, user]) => ({
              id,
              ...user,
              lastActive: user.lastActive || 0,
              status: user.blocked ? 'blocked' : 
                     (user.lastActive > Date.now() - 86400000 ? 'active' : 'inactive')
            }));
            
            this.updateUsersDisplay();
            this.updateDashboardCounts();
          } catch (error) {
            console.error('Error loading users:', error);
            utils.showToast('Failed to load users', 'error');
          }
        }, (error) => {
          console.error('Firebase error:', error);
          utils.showToast('Database connection error', 'error');
        });
      },
      
      updateUsersDisplay: function() {
        // Apply search filter if any
        const searchTerm = elements.userSearch.value.toLowerCase();
        appState.filteredUsers = appState.users.filter(user => 
          user.name.toLowerCase().includes(searchTerm) ||
          user.id.toLowerCase().includes(searchTerm) ||
          (user.location && user.location.toLowerCase().includes(searchTerm))
        );
        
        // Apply sorting
        appState.filteredUsers.sort((a, b) => {
          if (appState.sortColumn === 'status') {
            const statusOrder = { 'active': 1, 'inactive': 2, 'blocked': 3 };
            return appState.sortDirection === 'asc' 
              ? statusOrder[a.status] - statusOrder[b.status]
              : statusOrder[b.status] - statusOrder[a.status];
          } else {
            const aValue = a[appState.sortColumn] || '';
            const bValue = b[appState.sortColumn] || '';
            return appState.sortDirection === 'asc' 
              ? aValue.toString().localeCompare(bValue.toString())
              : bValue.toString().localeCompare(aValue.toString());
          }
        });
        
        // Update table
        elements.usersTableBody.innerHTML = '';
        elements.usersCount.textContent = appState.filteredUsers.length;
        
        if (appState.filteredUsers.length === 0) {
          elements.usersTableBody.innerHTML = `
            <tr>
              <td colspan="6">No users found</td>
            </tr>
          `;
          return;
        }
        
        appState.filteredUsers.forEach(user => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${user.id}</td>
            <td>${user.name || 'Unknown'}</td>
            <td>${user.location || 'Bulihan, Silang, Cavite'}</td>
            <td>${utils.formatDate(user.lastActive)}</td>
            <td>${user.activity || '-'}</td>
            <td><span class="status-badge ${user.status}">${user.status.charAt(0).toUpperCase() + user.status.slice(1)}</span></td>
          `;
          elements.usersTableBody.appendChild(tr);
        });
      },
      
      updateDashboardCounts: function() {
        const activeUsers = appState.users.filter(user => user.status === 'active').length;
        elements.activeUsersCount.textContent = activeUsers;
        elements.totalUsersCount.textContent = appState.users.length;
      },
      
            fetchNotifications: function() {
        const notificationRef = database.ref('notifications');
        notificationRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
          try {
            const notifications = snapshot.val() || {};
            appState.notifications = Object.entries(notifications).map(([id, notification]) => ({
              id,
              ...notification
            }));
            this.updateNotificationDisplay();
          } catch (error) {
            console.error('Error loading notifications:', error);
            utils.showToast('Failed to load notifications', 'error');
          }
        });
      },
      
      updateNotificationDisplay: function() {
        elements.notificationList.innerHTML = '';
        const unreadCount = appState.notifications.filter(n => !n.read).length;
        elements.notificationCount.textContent = unreadCount > 0 ? unreadCount : '';
        
        if (appState.notifications.length === 0) {
          elements.notificationList.innerHTML = '<li class="empty">No notifications</li>';
          return;
        }
        
        appState.notifications.slice(0, 10).forEach(notification => {
          const li = document.createElement('li');
          li.className = notification.read ? '' : 'unread';
          li.innerHTML = `
            <div class="notification-content">
              <p>${notification.message}</p>
              <small>${utils.formatRelativeTime(notification.timestamp)}</small>
            </div>
            ${!notification.read ? '<button class="mark-read" data-id="${notification.id}"><i class="fas fa-check"></i></button>' : ''}
          `;
          elements.notificationList.appendChild(li);
        });
      },
      
      markNotificationRead: function(notificationId) {
        database.ref(`notifications/${notificationId}`).update({ read: true });
      },
      
      markAllNotificationsRead: function() {
        const updates = {};
        appState.notifications.forEach(notification => {
          if (!notification.read) {
            updates[`notifications/${notification.id}/read`] = true;
          }
        });
        database.ref().update(updates);
      },
      
      fetchReports: function() {
        const reportsRef = database.ref('reports');
        reportsRef.orderByChild('timestamp').on('value', (snapshot) => {
          try {
            const reports = snapshot.val() || {};
            appState.reports = Object.entries(reports).map(([id, report]) => ({
              id,
              ...report,
              status: report.status || 'pending'
            }));
            this.updateReportsDisplay();
          } catch (error) {
            console.error('Error loading reports:', error);
            utils.showToast('Failed to load reports', 'error');
          }
        });
      },
      
      updateReportsDisplay: function() {
        // Apply filters
        const typeFilter = elements.reportTypeFilter.value;
        const statusFilter = elements.reportStatusFilter.value;
        const fromDate = elements.reportFromDate.value;
        const toDate = elements.reportToDate.value;
        
        appState.filteredReports = appState.reports.filter(report => {
          const matchesType = typeFilter === 'all' || report.type === typeFilter;
          const matchesStatus = statusFilter === 'all' || report.status === statusFilter;
          const matchesDate = (!fromDate || report.timestamp >= new Date(fromDate).getTime()) &&
                             (!toDate || report.timestamp <= new Date(toDate).getTime());
          
          return matchesType && matchesStatus && matchesDate;
        });
        
        // Pagination
        const totalPages = Math.ceil(appState.filteredReports.length / appState.itemsPerPage);
        const startIdx = (appState.currentPage - 1) * appState.itemsPerPage;
        const paginatedReports = appState.filteredReports.slice(startIdx, startIdx + appState.itemsPerPage);
        
        // Update UI
        elements.reportList.innerHTML = '';
        elements.pageInfo.textContent = `Page ${appState.currentPage} of ${totalPages}`;
        elements.prevPage.disabled = appState.currentPage <= 1;
        elements.nextPage.disabled = appState.currentPage >= totalPages;
        
        if (paginatedReports.length === 0) {
          elements.reportList.innerHTML = '<li class="empty">No reports found</li>';
          return;
        }
        
        paginatedReports.forEach(report => {
          const li = document.createElement('li');
          li.className = `report-item ${report.status}`;
          li.innerHTML = `
            <div class="report-header">
              <span class="report-id">#${report.id.substring(0, 8)}</span>
              <span class="report-type ${report.type}">${report.type}</span>
              <span class="report-status ${report.status}">${report.status}</span>
              <span class="report-date">${utils.formatDate(report.timestamp)}</span>
            </div>
            <div class="report-content">
              <p><strong>Reporter:</strong> ${report.reporterName || 'Anonymous'}</p>
              <p><strong>Reported User:</strong> ${report.reportedUserName || 'Unknown'}</p>
              <p><strong>Details:</strong> ${report.details || 'No details provided'}</p>
            </div>
            <div class="report-actions">
              ${report.status === 'pending' ? 
                '<button class="btn-resolve" data-id="${report.id}">Resolve</button>' : 
                '<button class="btn-view" data-id="${report.id}">View</button>'}
            </div>
          `;
          elements.reportList.appendChild(li);
        });
      },
      
      resolveReport: function(reportId) {
        database.ref(`reports/${reportId}`).update({ status: 'resolved' })
          .then(() => utils.showToast('Report resolved successfully'))
          .catch(error => {
            console.error('Error resolving report:', error);
            utils.showToast('Failed to resolve report', 'error');
          });
      },
      
      fetchZones: function() {
        const zonesRef = database.ref('zones');
        zonesRef.on('value', (snapshot) => {
          try {
            const zones = snapshot.val() || {};
            appState.zones = Object.entries(zones).map(([id, zone]) => ({
              id,
              ...zone
            }));
            this.updateZonesDisplay();
          } catch (error) {
            console.error('Error loading zones:', error);
            utils.showToast('Failed to load zones', 'error');
          }
        });
      },
      
      updateZonesDisplay: function() {
        elements.zoneList.innerHTML = '';
        
        if (appState.zones.length === 0) {
          elements.zoneList.innerHTML = '<li class="empty">No zones configured</li>';
          return;
        }
        
        appState.zones.forEach(zone => {
          const li = document.createElement('li');
          li.className = zone.id === appState.currentZone ? 'active' : '';
          li.innerHTML = `
            <h4>${zone.name}</h4>
            <p>${zone.users || 0} active users</p>
            <button class="btn-view-zone" data-id="${zone.id}">View</button>
          `;
          elements.zoneList.appendChild(li);
        });
      },
      
      initializeMap: function() {
        if (!appState.mapInitialized) {
          // Initialize map with default coordinates
          elements.monitoringMap = L.map('monitoring-map').setView([14.2307, 120.9752], 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(elements.monitoringMap);
          
          // Add user markers
          appState.users.forEach(user => {
            if (user.location && user.location.coordinates) {
              const marker = L.marker([user.location.coordinates.lat, user.location.coordinates.lng])
                .addTo(elements.monitoringMap)
                .bindPopup(`<b>${user.name}</b><br>${user.status}`);
            }
          });
          
          appState.mapInitialized = true;
        }
      },
      
      initializeZoneMap: function(zoneId) {
        const zone = appState.zones.find(z => z.id === zoneId);
        if (!zone) return;
        
        if (!appState.zoneMapInitialized) {
          elements.zoneMap = L.map('zone-map').setView([zone.center.lat, zone.center.lng], 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(elements.zoneMap);
          
          // Add zone boundary
          if (zone.boundary) {
            L.polygon(zone.boundary, {color: '#3388ff'}).addTo(elements.zoneMap);
          }
          
          // Add users in zone
          appState.users.forEach(user => {
            if (user.location && user.location.coordinates && this.isPointInZone(user.location.coordinates, zone.boundary)) {
              L.marker([user.location.coordinates.lat, user.location.coordinates.lng])
                .addTo(elements.zoneMap)
                .bindPopup(`<b>${user.name}</b><br>${user.status}`);
            }
          });
          
          appState.zoneMapInitialized = true;
        }
      },
      
      isPointInZone: function(point, polygon) {
        // Ray-casting algorithm to check if point is in polygon
        let inside = false;
        for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
          const xi = polygon[i][0], yi = polygon[i][1];
          const xj = polygon[j][0], yj = polygon[j][1];
          
          const intersect = ((yi > point.lat) !== (yj > point.lat))
            && (point.lng < (xj - xi) * (point.lat - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
        }
        return inside;
      },
      
      blockUser: function(userId) {
        database.ref(`users/${userId}`).update({ blocked: true })
          .then(() => utils.showToast('User blocked successfully'))
          .catch(error => {
            console.error('Error blocking user:', error);
            utils.showToast('Failed to block user', 'error');
          });
      },
      
      unblockUser: function(userId) {
        database.ref(`users/${userId}`).update({ blocked: false })
          .then(() => utils.showToast('User unblocked successfully'))
          .catch(error => {
            console.error('Error unblocking user:', error);
            utils.showToast('Failed to unblock user', 'error');
          });
      },
      
      exportReports: function() {
        const csvContent = "data:text/csv;charset=utf-8," 
          + "ID,Type,Status,Reporter,Reported User,Details,Timestamp\n"
          + appState.filteredReports.map(report => 
              `${report.id},${report.type},${report.status},"${report.reporterName}","${report.reportedUserName}","${report.details}",${utils.formatDate(report.timestamp)}`
            ).join("\n");
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "reports_export.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    };

    // Authentication Functions
    const authFunctions = {
      checkAuthState: function() {
        auth.onAuthStateChanged((user) => {
          if (user) {
            // Verify admin role before allowing access
            database.ref(`admins/${user.uid}`).once('value')
              .then((snapshot) => {
                if (snapshot.exists()) {
                  appState.currentUser = {
                    uid: user.uid,
                    email: user.email,
                    isAdmin: true
                  };
                  this.initializeApp();
                } else {
                  utils.showToast('You do not have admin privileges', 'error');
                  this.logout();
                }
              })
              .catch((error) => {
                console.error('Error checking admin status:', error);
                utils.showToast('Authentication error', 'error');
                this.logout();
              });
          } else {
            window.location.href = 'login.html';
          }
        });
      },
      
      logout: function() {
        auth.signOut()
          .then(() => {
            window.location.href = 'login.html';
          })
          .catch((error) => {
            console.error('Logout error:', error);
            utils.showToast('Logout failed', 'error');
          });
      }
    };

    // App Initialization
    const app = {
      initializeApp: function() {
        // Load all data
        firebaseData.fetchUsers();
        firebaseData.fetchNotifications();
        firebaseData.fetchReports();
        firebaseData.fetchZones();
        
        // Set up event listeners
        this.setupEventListeners();
        
        // Show home section by default
        this.showSection('home');
      },
      
      setupEventListeners: function() {
        // Navigation
        elements.navLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const section = e.target.getAttribute('data-section');
            this.showSection(section);
          });
        });
        
        // Logout
        elements.logoutBtn.addEventListener('click', authFunctions.logout);
        
        // User search
        elements.userSearch.addEventListener('input', utils.debounce(() => {
          firebaseData.updateUsersDisplay();
        }, 300));
        
        // Reports filters
        elements.applyFilters.addEventListener('click', () => {
          appState.currentPage = 1;
          firebaseData.updateReportsDisplay();
        });
        
        elements.clearFilters.addEventListener('click', () => {
          elements.reportTypeFilter.value = 'all';
          elements.reportStatusFilter.value = 'all';
          elements.reportFromDate.value = '';
          elements.reportToDate.value = '';
          appState.currentPage = 1;
          firebaseData.updateReportsDisplay();
        });
        
        // Pagination
        elements.prevPage.addEventListener('click', () => {
          if (appState.currentPage > 1) {
            appState.currentPage--;
            firebaseData.updateReportsDisplay();
          }
        });
        
        elements.nextPage.addEventListener('click', () => {
          const totalPages = Math.ceil(appState.filteredReports.length / appState.itemsPerPage);
          if (appState.currentPage < totalPages) {
            appState.currentPage++;
            firebaseData.updateReportsDisplay();
          }
        });
        
        // Notifications
        elements.markAllRead.addEventListener('click', () => {
          firebaseData.markAllNotificationsRead();
        });
        
        // Delegated event listeners
        document.addEventListener('click', (e) => {
          // Notification mark as read
          if (e.target.closest('.mark-read')) {
            const notificationId = e.target.closest('.mark-read').getAttribute('data-id');
            firebaseData.markNotificationRead(notificationId);
          }
          
          // Report resolve
          if (e.target.closest('.btn-resolve')) {
            const reportId = e.target.closest('.btn-resolve').getAttribute('data-id');
            utils.showConfirmation('Resolve Report', 'Are you sure you want to mark this report as resolved?')
              .then(confirmed => {
                if (confirmed) {
                  firebaseData.resolveReport(reportId);
                }
              });
          }
          
          // View zone
          if (e.target.closest('.btn-view-zone')) {
            const zoneId = e.target.closest('.btn-view-zone').getAttribute('data-id');
            appState.currentZone = zoneId;
            firebaseData.updateZonesDisplay();
            this.showSection('location');
            firebaseData.initializeZoneMap(zoneId);
          }
        });
      },
      
      showSection: function(section) {
        // Hide all sections
        elements.contentSections.forEach(sec => {
          sec.style.display = 'none';
        });
        
        // Show selected section
        document.getElementById(`${section}-section`).style.display = 'block';
        appState.activeTab = section;
        
        // Initialize map if showing home section
        if (section === 'home' && !appState.mapInitialized) {
          setTimeout(() => firebaseData.initializeMap(), 500);
        }
        
        // Initialize zone map if showing location section with selected zone
        if (section === 'location' && appState.currentZone !== 'all' && !appState.zoneMapInitialized) {
          setTimeout(() => firebaseData.initializeZoneMap(appState.currentZone), 500);
        }
      }
    };

    // Start the app
    document.addEventListener('DOMContentLoaded', () => {
      authFunctions.checkAuthState();
    });

    // Error handling
    window.addEventListener('error', (event) => {
      console.error('Unhandled error:', event.error);
      utils.showToast('An unexpected error occurred', 'error');
      
      // Log error to server if available
      if (appState.currentUser) {
        database.ref('errors').push({
          error: event.error.toString(),
          stack: event.error.stack,
          userId: appState.currentUser.uid,
          timestamp: Date.now()
        });
      }
    });

    // Cleanup Firebase listeners when page unloads
    window.addEventListener('beforeunload', () => {
      // In a real app, we would keep track of all listeners and detach them here
      database.ref('users').off();
      database.ref('notifications').off();
      database.ref('reports').off();
      database.ref('zones').off();
    });
</script>
</body>
</html>