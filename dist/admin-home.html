<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TradeConnect Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css">
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #4895ef;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      display: flex;
      min-height: 100vh;
      background-color: #f5f7fa;
    }
    
    /* Sidebar */
    .sidebar {
      width: 250px;
      background-color: white;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      z-index: 100;
    }
    
    .logo {
      text-align: center;
      padding: 0 20px 20px;
      border-bottom: 1px solid var(--light-gray);
      margin-bottom: 20px;
    }
    
    .logo h2 {
      color: var(--primary);
      font-size: 1.5rem;
    }
    
    .nav-menu {
      flex-grow: 1;
      overflow-y: auto;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--gray);
      text-decoration: none;
      transition: all 0.3s;
    }
    
    .nav-link i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    .nav-link:hover, .nav-link.active {
      background-color: rgba(67, 97, 238, 0.1);
      color: var(--primary);
    }
    
    .nav-link.active {
      border-left: 3px solid var(--primary);
    }
    
    .logout-btn {
      margin-top: auto;
      padding: 15px 20px;
      background-color: var(--light-gray);
      border: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      color: var(--danger);
      transition: all 0.3s;
    }
    
    .logout-btn:hover {
      background-color: rgba(247, 37, 133, 0.1);
    }
    
    .logout-btn i {
      margin-right: 10px;
    }
    
    /* Main Content */
    .main-content {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: var(--dark);
      font-size: 1.8rem;
    }
    
    .user-info {
      display: flex;
      align-items: center;
    }
    
    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }
    
    .notification-icon {
      position: relative;
      margin-right: 20px;
      cursor: pointer;
    }
    
    .notification-icon i {
      font-size: 1.2rem;
      color: var(--gray);
    }
    
    .notification-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--danger);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
    }
    
    /* Content Sections */
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    /* Dashboard Cards */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .card-title {
      font-size: 1rem;
      color: var(--gray);
    }
    
    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .card-icon.users {
      background-color: var(--primary);
    }
    
    .card-icon.active {
      background-color: var(--success);
    }
    
    .card-icon.items {
      background-color: var(--warning);
    }
    
    .card-icon.trades {
      background-color: var(--info);
    }
    
    .card-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--dark);
      margin-bottom: 5px;
    }
    
    .card-footer {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    /* Tables */
    .table-container {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--light-gray);
    }
    
    th {
      background-color: var(--light);
      color: var(--dark);
      font-weight: 600;
    }
    
    tr:hover {
      background-color: rgba(67, 97, 238, 0.05);
    }
    
    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-badge.active {
      background-color: rgba(76, 201, 240, 0.2);
      color: var(--success);
    }
    
    .status-badge.inactive {
      background-color: rgba(108, 117, 125, 0.2);
      color: var(--gray);
    }
    
    .status-badge.blocked {
      background-color: rgba(247, 37, 133, 0.2);
      color: var(--danger);
    }
    
    /* Maps */
    .map-container {
      height: 400px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }
    
    #monitoring-map, #zone-map {
      height: 100%;
      width: 100%;
    }
    
    /* Reports */
    .report-item {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .report-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }
    
    .report-id {
      font-weight: bold;
      color: var(--dark);
    }
    
    .report-type, .report-status {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .report-type.scam {
      background-color: rgba(247, 37, 133, 0.2);
      color: var(--danger);
    }
    
    .report-type.harassment {
      background-color: rgba(248, 150, 30, 0.2);
      color: var(--warning);
    }
    
    .report-type.fake-item {
      background-color: rgba(114, 9, 183, 0.2);
      color: #7209b7;
    }
    
    .report-type.other {
      background-color: rgba(108, 117, 125, 0.2);
      color: var(--gray);
    }
    
    .report-status.pending {
      background-color: rgba(248, 150, 30, 0.2);
      color: var(--warning);
    }
    
    .report-status.resolved {
      background-color: rgba(76, 201, 240, 0.2);
      color: var(--success);
    }
    
    .report-status.rejected {
      background-color: rgba(108, 117, 125, 0.2);
      color: var(--gray);
    }
    
    .report-date {
      margin-left: auto;
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .report-content p {
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
    
    .report-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }
    
    .btn-resolve, .btn-view {
      padding: 5px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .btn-resolve {
      background-color: var(--success);
      color: white;
    }
    
    .btn-resolve:hover {
      background-color: #3aa8d8;
    }
    
    .btn-view {
      background-color: var(--light-gray);
      color: var(--dark);
    }
    
    .btn-view:hover {
      background-color: #d1d7dd;
    }
    
    /* Filters */
    .filters-container {
      background-color: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-end;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    
    .filter-group label {
      font-size: 0.8rem;
      color: var(--gray);
      margin-bottom: 5px;
    }
    
    .filter-group select, .filter-group input {
      padding: 8px 12px;
      border: 1px solid var(--light-gray);
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .filter-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn-apply, .btn-clear, .btn-export {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .btn-apply {
      background-color: var(--primary);
      color: white;
    }
    
    .btn-apply:hover {
      background-color: var(--secondary);
    }
    
    .btn-clear {
      background-color: var(--light-gray);
      color: var(--dark);
    }
    
    .btn-clear:hover {
      background-color: #d1d7dd;
    }
    
    .btn-export {
      background-color: var(--info);
      color: white;
      margin-left: auto;
    }
    
    .btn-export:hover {
      background-color: #3d7fc1;
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      gap: 15px;
    }
    
    .page-info {
      font-size: 0.9rem;
      color: var(--gray);
    }
    
    .btn-prev, .btn-next {
      padding: 5px 10px;
      border: 1px solid var(--light-gray);
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-prev:hover, .btn-next:hover {
      background-color: var(--light);
    }
    
    .btn-prev:disabled, .btn-next:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Zones */
    .zone-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .zone-item {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: all 0.3s;
    }
    
    .zone-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
    }
    
    .zone-item.active {
      border-left: 4px solid var(--primary);
    }
    
    .zone-item h4 {
      margin-bottom: 5px;
      color: var(--dark);
    }
    
    .zone-item p {
      font-size: 0.9rem;
      color: var(--gray);
      margin-bottom: 10px;
    }
    
    .btn-view-zone {
      padding: 5px 15px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s;
    }
    
    .btn-view-zone:hover {
      background-color: var(--secondary);
    }
    
    /* Notifications */
    .notification-dropdown {
      position: absolute;
      top: 40px;
      right: 0;
      width: 300px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: none;
    }
    
    .notification-dropdown.show {
      display: block;
    }
    
    .notification-header {
      padding: 15px;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .notification-header h4 {
      color: var(--dark);
    }
    
    .mark-all-read {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .notification-item {
      padding: 12px 15px;
      border-bottom: 1px solid var(--light-gray);
      transition: all 0.3s;
    }
    
    .notification-item.unread {
      background-color: rgba(67, 97, 238, 0.05);
    }
    
    .notification-item:hover {
      background-color: var(--light);
    }
    
    .notification-content p {
      font-size: 0.9rem;
      margin-bottom: 5px;
    }
    
    .notification-content small {
      font-size: 0.7rem;
      color: var(--gray);
    }
    
    .mark-read {
      background: none;
      border: none;
      color: var(--success);
      cursor: pointer;
      margin-left: auto;
    }
    
    .empty {
      text-align: center;
      padding: 20px;
      color: var(--gray);
    }
    
    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    .toast {
      padding: 12px 20px;
      border-radius: 8px;
      background-color: white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      animation: slideIn 0.3s, fadeOut 0.5s 4.5s forwards;
    }
    
    .toast i {
      margin-right: 10px;
      font-size: 1.2rem;
    }
    
    .toast.success {
      border-left: 4px solid var(--success);
      color: var(--success);
    }
    
    .toast.error {
      border-left: 4px solid var(--danger);
      color: var(--danger);
    }
    
    .toast.info {
      border-left: 4px solid var(--info);
      color: var(--info);
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    /* Confirmation Dialog */
    .confirmation-dialog {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    
    .dialog-content {
      background-color: white;
      border-radius: 10px;
      padding: 25px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }
    
    .dialog-title {
      font-size: 1.2rem;
      color: var(--dark);
      margin-bottom: 10px;
    }
    
    .dialog-message {
      font-size: 0.9rem;
      color: var(--gray);
      margin-bottom: 20px;
    }
    
    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .dialog-cancel, .dialog-confirm {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    
    .dialog-cancel {
      background-color: var(--light-gray);
      color: var(--dark);
    }
    
    .dialog-cancel:hover {
      background-color: #d1d7dd;
    }
    
    .dialog-confirm {
      background-color: var(--danger);
      color: white;
    }
    
    .dialog-confirm:hover {
      background-color: #e5177b;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        padding: 10px;
      }
      
      .logo {
        display: none;
      }
      
      .nav-menu {
        display: flex;
        overflow-x: auto;
        padding-bottom: 5px;
      }
      
      .nav-link {
        padding: 10px 15px;
        white-space: nowrap;
      }
      
      .nav-link i {
        margin-right: 5px;
      }
      
      .logout-btn {
        display: none;
      }
      
      .main-content {
        padding: 15px;
      }
      
      .dashboard-cards {
        grid-template-columns: 1fr 1fr;
      }
      
      .zone-list {
        grid-template-columns: 1fr;
      }
      
      .notification-dropdown {
        width: 280px;
        right: -50px;
      }
    }
    
    @media (max-width: 480px) {
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      
      .filters-container {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-actions {
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <h2>TradeConnect</h2>
      <p>Admin Dashboard</p>
    </div>
    
    <nav class="nav-menu">
      <a href="#" class="nav-link active" data-section="home">
        <i class="fas fa-home"></i>
        Dashboard
      </a>
      <a href="#" class="nav-link" data-section="users">
        <i class="fas fa-users"></i>
        User Management
      </a>
      <a href="#" class="nav-link" data-section="location">
        <i class="fas fa-map-marker-alt"></i>
        Location Monitoring
      </a>
      <a href="#" class="nav-link" data-section="reports">
        <i class="fas fa-flag"></i>
        Reports
      </a>
      <a href="#" class="nav-link" data-section="settings">
        <i class="fas fa-cog"></i>
        Settings
      </a>
    </nav>
    
    <button class="logout-btn" id="logout-btn">
      <i class="fas fa-sign-out-alt"></i>
      Logout
    </button>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content">
    <div class="header">
      <h1 id="page-title">Dashboard</h1>
      
      <div class="user-info">
        <div class="notification-icon" id="notification-icon">
          <i class="fas fa-bell"></i>
          <span class="notification-count"></span>
          
          <div class="notification-dropdown" id="notification-dropdown">
            <div class="notification-header">
              <h4>Notifications</h4>
              <button class="mark-all-read">Mark all as read</button>
            </div>
            <ul class="notification-list">
              <li class="empty">No notifications</li>
            </ul>
          </div>
        </div>
        
        <img src="https://ui-avatars.com/api/?name=Admin+User&background=4361ee&color=fff" alt="Admin User">
        <span>Admin User</span>
      </div>
    </div>
    
    <!-- Home/Dashboard Section -->
    <section id="home-section" class="content-section active">
      <div class="dashboard-cards">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Active Users</h3>
            <div class="card-icon active">
              <i class="fas fa-user-check"></i>
            </div>
          </div>
          <div class="card-value" id="active-users-count">0</div>
          <div class="card-footer">Today</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Total Users</h3>
            <div class="card-icon users">
              <i class="fas fa-users"></i>
            </div>
          </div>
          <div class="card-value" id="total-users-count">0</div>
          <div class="card-footer">All time</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Best Selling Item</h3>
            <div class="card-icon items">
              <i class="fas fa-shopping-bag"></i>
            </div>
          </div>
          <div class="card-value" id="best-selling-item">-</div>
          <div class="card-footer">This week</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Best Trade Item</h3>
            <div class="card-icon trades">
              <i class="fas fa-exchange-alt"></i>
            </div>
          </div>
          <div class="card-value" id="best-trade-item">-</div>
          <div class="card-footer">This week</div>
        </div>
      </div>
      
      <div class="map-container">
        <div id="monitoring-map"></div>
      </div>
    </section>
    
    <!-- Users Section -->
    <section id="users-section" class="content-section">
      <div class="table-container">
        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2>User Management</h2>
          <input type="text" id="user-search" placeholder="Search users..." style="padding: 8px 12px; border: 1px solid #e9ecef; border-radius: 4px; width: 250px;">
        </div>
        
        <div style="margin-bottom: 15px; font-size: 0.9rem; color: #6c757d;">
          Showing <span id="users-count">0</span> users
        </div>
        
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Location</th>
                <th>Last Active</th>
                <th>Activity</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <tr>
                <td colspan="6">Loading users...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- Location Section -->
    <section id="location-section" class="content-section">
      <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
        <div>
          <h2 style="margin-bottom: 20px;">Zones</h2>
          <ul class="zone-list" id="zone-list">
            <li class="empty">Loading zones...</li>
          </ul>
        </div>
        
        <div>
          <h2 style="margin-bottom: 20px;">Zone Monitoring</h2>
          <div style="margin-bottom: 15px; font-size: 0.9rem; color: #6c757d;">
            <span id="zone-active-users">0</span> active users in this zone
          </div>
          <div class="map-container">
            <div id="zone-map"></div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Reports Section -->
    <section id="reports-section" class="content-section">
      <div class="table-container">
        <h2 style="margin-bottom: 20px;">Reports Management</h2>
        
        <div class="filters-container">
          <div class="filter-group">
            <label for="report-type-filter">Type</label>
            <select id="report-type-filter">
              <option value="all">All Types</option>
              <option value="scam">Scam</option>
              <option value="harassment">Harassment</option>
              <option value="fake-item">Fake Item</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="report-status-filter">Status</label>
            <select id="report-status-filter">
              <option value="all">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="resolved">Resolved</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="report-from-date">From Date</label>
            <input type="date" id="report-from-date">
          </div>
          
          <div class="filter-group">
            <label for="report-to-date">To Date</label>
            <input type="date" id="report-to-date">
          </div>
          
          <div class="filter-actions">
            <button class="btn-apply" id="apply-filters">Apply</button>
            <button class="btn-clear" id="clear-filters">Clear</button>
            <button class="btn-export" id="export-reports">Export</button>
          </div>
        </div>
        
        <ul class="report-list" id="report-list">
          <li class="empty">Loading reports...</li>
        </ul>
        
        <div class="pagination">
          <button class="btn-prev" id="prev-page" disabled>
            <i class="fas fa-chevron-left"></i>
          </button>
          <span class="page-info" id="page-info">Page 1 of 1</span>
          <button class="btn-next" id="next-page" disabled>
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </section>
    
    <!-- Settings Section -->
    <section id="settings-section" class="content-section">
      <div class="table-container">
        <h2 style="margin-bottom: 20px;">System Settings</h2>
        <p>Settings content will go here</p>
      </div>
    </section>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Confirmation Dialog -->
    <div id="confirmation-dialog" class="confirmation-dialog">
      <div class="dialog-content">
        <h3 class="dialog-title" id="dialog-title">Confirm Action</h3>
        <p class="dialog-message" id="dialog-message">Are you sure you want to perform this action?</p>
        <div class="dialog-actions">
          <button class="dialog-cancel" id="dialog-cancel">Cancel</button>
          <button class="dialog-confirm" id="dialog-confirm">Confirm</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase and other libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>

  <script>
    // Enhanced Admin Dashboard with localStorage and improved routing
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCxaOGeOvHwS5dnPHRTpw3Lwn2surjXP1E",
      authDomain: "tradeconnect-3c728.firebaseapp.com",
      projectId: "tradeconnect-3c728",
      storageBucket: "tradeconnect-3c728.appspot.com",
      messagingSenderId: "299665603548",
      appId: "1:299665603548:web:9ff10af44cd41605382d19",
      databaseURL: "https://tradeconnect-3c728-default-rtdb.firebaseio.com"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // App State with localStorage integration
    const appState = {
      currentUser: null,
      users: [],
      filteredUsers: [],
      reports: [],
      filteredReports: [],
      notifications: [],
      zones: [],
      currentZone: 'all',
      currentPage: 1,
      itemsPerPage: 10,
      sortColumn: 'lastActive',
      sortDirection: 'desc',
      activeTab: 'home',
      mapInitialized: false,
      zoneMapInitialized: false,
      
      // Load state from localStorage
      loadState: function() {
        const savedState = localStorage.getItem('adminDashboardState');
        if (savedState) {
          try {
            const parsedState = JSON.parse(savedState);
            this.currentPage = parsedState.currentPage || 1;
            this.currentZone = parsedState.currentZone || 'all';
            this.activeTab = parsedState.activeTab || 'home';
          } catch (e) {
            console.error('Error loading state from localStorage:', e);
          }
        }
      },
      
      // Save state to localStorage
      saveState: function() {
        const stateToSave = {
          currentPage: this.currentPage,
          currentZone: this.currentZone,
          activeTab: this.activeTab
        };
        localStorage.setItem('adminDashboardState', JSON.stringify(stateToSave));
      }
    };

    // Load initial state
    appState.loadState();

    // DOM Elements
    const elements = {
      // Navigation
      navLinks: document.querySelectorAll('.nav-link'),
      contentSections: document.querySelectorAll('.content-section'),
      logoutBtn: document.getElementById('logout-btn'),
      pageTitle: document.getElementById('page-title'),
      
      // Home Section
      activeUsersCount: document.getElementById('active-users-count'),
      totalUsersCount: document.getElementById('total-users-count'),
      bestSellingItem: document.getElementById('best-selling-item'),
      bestTradeItem: document.getElementById('best-trade-item'),
      monitoringMap: null,
      
      // Users Section
      userSearch: document.getElementById('user-search'),
      usersTableBody: document.getElementById('users-table-body'),
      usersCount: document.getElementById('users-count'),
      
      // Location Section
      zoneList: document.getElementById('zone-list'),
      zoneMap: null,
      zoneActiveUsers: document.getElementById('zone-active-users'),
      
      // Reports Section
      reportList: document.getElementById('report-list'),
      reportTypeFilter: document.getElementById('report-type-filter'),
      reportStatusFilter: document.getElementById('report-status-filter'),
      reportFromDate: document.getElementById('report-from-date'),
      reportToDate: document.getElementById('report-to-date'),
      applyFilters: document.getElementById('apply-filters'),
      clearFilters: document.getElementById('clear-filters'),
      exportReports: document.getElementById('export-reports'),
      prevPage: document.getElementById('prev-page'),
      nextPage: document.getElementById('next-page'),
      pageInfo: document.getElementById('page-info'),
      
      // Notifications
      notificationIcon: document.getElementById('notification-icon'),
      notificationDropdown: document.getElementById('notification-dropdown'),
      notificationList: document.querySelector('.notification-list'),
      notificationCount: document.querySelector('.notification-count'),
      markAllRead: document.querySelector('.mark-all-read'),
      
      // Toast and Dialogs
      toastContainer: document.getElementById('toast-container'),
      confirmationDialog: document.getElementById('confirmation-dialog'),
      dialogTitle: document.getElementById('dialog-title'),
      dialogMessage: document.getElementById('dialog-message'),
      dialogCancel: document.getElementById('dialog-cancel'),
      dialogConfirm: document.getElementById('dialog-confirm')
    };

    // Utility Functions
    const utils = {
      debounce: function(func, timeout = 300) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
      },
      
      showToast: function(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
          <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
          <span>${message}</span>
        `;
        elements.toastContainer.appendChild(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 5000);
      },
      
      showConfirmation: function(title, message) {
        return new Promise((resolve) => {
          elements.dialogTitle.textContent = title;
          elements.dialogMessage.textContent = message;
          elements.confirmationDialog.style.display = 'flex';
          
          elements.dialogCancel.onclick = () => {
            elements.confirmationDialog.style.display = 'none';
            resolve(false);
          };
          
          elements.dialogConfirm.onclick = () => {
            elements.confirmationDialog.style.display = 'none';
            resolve(true);
          };
        });
      },
      
      formatDate: function(timestamp) {
        return moment(timestamp).format('MMM D, YYYY h:mm A');
      },
      
      formatRelativeTime: function(timestamp) {
        return moment(timestamp).fromNow();
      },
      
      // Check if user is authenticated and is admin
      checkAdminAuth: function() {
        const user = auth.currentUser;
        if (!user) {
          window.location.href = 'login.html';
          return false;
        }
        
        // Check if user is admin (from localStorage or Firebase)
        const isAdmin = localStorage.getItem('isAdmin') === 'true';
        if (!isAdmin) {
          database.ref(`admins/${user.uid}`).once('value')
            .then((snapshot) => {
              if (!snapshot.exists()) {
                utils.showToast('You do not have admin privileges', 'error');
                authFunctions.logout();
                return false;
              }
              localStorage.setItem('isAdmin', 'true');
              return true;
            })
            .catch((error) => {
              console.error('Error checking admin status:', error);
              utils.showToast('Authentication error', 'error');
              authFunctions.logout();
              return false;
            });
        }
        return true;
      }
    };

    // Firebase Data Functions
    const firebaseData = {
      fetchUsers: function() {
        const usersRef = database.ref('users');
        usersRef.on('value', (snapshot) => {
          try {
            const users = snapshot.val() || {};
            appState.users = Object.entries(users).map(([id, user]) => ({
              id,
              ...user,
              lastActive: user.lastActive || 0,
              status: user.blocked ? 'blocked' : 
                     (user.lastActive > Date.now() - 86400000 ? 'active' : 'inactive')
            }));
            
            this.updateUsersDisplay();
            this.updateDashboardCounts();
            
            // Update map if it's already initialized
            if (appState.mapInitialized && elements.monitoringMap) {
              this.updateUserMarkers();
            }
          } catch (error) {
            console.error('Error loading users:', error);
            utils.showToast('Failed to load users', 'error');
          }
        }, (error) => {
          console.error('Firebase error:', error);
          utils.showToast('Database connection error', 'error');
        });
      },
      
      updateUsersDisplay: function() {
        // Apply search filter if any
        const searchTerm = elements.userSearch.value.toLowerCase();
        appState.filteredUsers = appState.users.filter(user => 
          (user.name && user.name.toLowerCase().includes(searchTerm)) ||
          user.id.toLowerCase().includes(searchTerm) ||
          (user.location && typeof user.location === 'string' && user.location.toLowerCase().includes(searchTerm))
        );
        
        // Apply sorting
        appState.filteredUsers.sort((a, b) => {
          if (appState.sortColumn === 'status') {
            const statusOrder = { 'active': 1, 'inactive': 2, 'blocked': 3 };
            return appState.sortDirection === 'asc' 
              ? statusOrder[a.status] - statusOrder[b.status]
              : statusOrder[b.status] - statusOrder[a.status];
          } else {
            const aValue = a[appState.sortColumn] || '';
            const bValue = b[appState.sortColumn] || '';
            return appState.sortDirection === 'asc' 
              ? aValue.toString().localeCompare(bValue.toString())
              : bValue.toString().localeCompare(aValue.toString());
          }
        });
        
        // Update table
        elements.usersTableBody.innerHTML = '';
        elements.usersCount.textContent = appState.filteredUsers.length;
        
        if (appState.filteredUsers.length === 0) {
          elements.usersTableBody.innerHTML = `
            <tr>
              <td colspan="6">No users found</td>
            </tr>
          `;
          return;
        }
        
        appState.filteredUsers.forEach(user => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${user.id}</td>
            <td>${user.name || 'Unknown'}</td>
            <td>${typeof user.location === 'string' ? user.location : 
                 (user.location && user.location.address ? user.location.address : 'Bulihan, Silang, Cavite')}</td>
            <td>${utils.formatDate(user.lastActive)}</td>
            <td>${user.activity || '-'}</td>
            <td><span class="status-badge ${user.status}">${user.status.charAt(0).toUpperCase() + user.status.slice(1)}</span></td>
          `;
          elements.usersTableBody.appendChild(tr);
        });
      },
      
      updateDashboardCounts: function() {
        const activeUsers = appState.users.filter(user => user.status === 'active').length;
        elements.activeUsersCount.textContent = activeUsers;
        elements.totalUsersCount.textContent = appState.users.length;
        
        // Simulate best selling and trade items (in a real app, this would come from the database)
        if (appState.users.length > 0) {
          elements.bestSellingItem.textContent = 'Smartphone';
          elements.bestTradeItem.textContent = 'Laptop';
        }
      },
      
      updateUserMarkers: function() {
        // Clear existing markers
        if (elements.monitoringMap) {
          elements.monitoringMap.eachLayer(layer => {
            if (layer instanceof L.Marker) {
              elements.monitoringMap.removeLayer(layer);
            }
          });
          
          // Add new markers
          appState.users.forEach(user => {
            if (user.location && user.location.coordinates) {
              const marker = L.marker([user.location.coordinates.lat, user.location.coordinates.lng])
                .addTo(elements.monitoringMap)
                .bindPopup(`<b>${user.name || 'Unknown'}</b><br>Status: ${user.status}`);
            }
          });
        }
      },
      
      fetchNotifications: function() {
        const notificationRef = database.ref('notifications');
        notificationRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
          try {
            const notifications = snapshot.val() || {};
            appState.notifications = Object.entries(notifications).map(([id, notification]) => ({
              id,
              ...notification
            }));
            this.updateNotificationDisplay();
          } catch (error) {
            console.error('Error loading notifications:', error);
            utils.showToast('Failed to load notifications', 'error');
          }
        });
      },
      
      updateNotificationDisplay: function() {
        elements.notificationList.innerHTML = '';
        const unreadCount = appState.notifications.filter(n => !n.read).length;
        elements.notificationCount.textContent = unreadCount > 0 ? unreadCount : '';
        
        if (appState.notifications.length === 0) {
          elements.notificationList.innerHTML = '<li class="empty">No notifications</li>';
          return;
        }
        
        appState.notifications.slice(0, 10).forEach(notification => {
          const li = document.createElement('li');
          li.className = notification.read ? '' : 'unread';
          li.innerHTML = `
            <div class="notification-content">
              <p>${notification.message}</p>
              <small>${utils.formatRelativeTime(notification.timestamp)}</small>
            </div>
            ${!notification.read ? '<button class="mark-read" data-id="${notification.id}"><i class="fas fa-check"></i></button>' : ''}
          `;
          elements.notificationList.appendChild(li);
        });
      },
      
      markNotificationRead: function(notificationId) {
        database.ref(`notifications/${notificationId}`).update({ read: true });
      },
      
      markAllNotificationsRead: function() {
        const updates = {};
        appState.notifications.forEach(notification => {
          if (!notification.read) {
            updates[`notifications/${notification.id}/read`] = true;
          }
        });
        database.ref().update(updates)
          .then(() => utils.showToast('All notifications marked as read'))
          .catch(error => {
            console.error('Error marking notifications as read:', error);
            utils.showToast('Failed to mark notifications as read', 'error');
          });
      },
      
      fetchReports: function() {
        const reportsRef = database.ref('reports');
        reportsRef.orderByChild('timestamp').on('value', (snapshot) => {
          try {
            const reports = snapshot.val() || {};
            appState.reports = Object.entries(reports).map(([id, report]) => ({
              id,
              ...report,
              status: report.status || 'pending'
            }));
            this.updateReportsDisplay();
          } catch (error) {
            console.error('Error loading reports:', error);
            utils.showToast('Failed to load reports', 'error');
          }
        });
      },
      
      updateReportsDisplay: function() {
        // Apply filters
        const typeFilter = elements.reportTypeFilter.value;
        const statusFilter = elements.reportStatusFilter.value;
        const fromDate = elements.reportFromDate.value;
        const toDate = elements.reportToDate.value;
        
        appState.filteredReports = appState.reports.filter(report => {
          const matchesType = typeFilter === 'all' || report.type === typeFilter;
          const matchesStatus = statusFilter === 'all' || report.status === statusFilter;
          const matchesDate = (!fromDate || report.timestamp >= new Date(fromDate).getTime()) &&
                             (!toDate || report.timestamp <= new Date(toDate).getTime());
          
          return matchesType && matchesStatus && matchesDate;
        });
        
        // Pagination
        const totalPages = Math.ceil(appState.filteredReports.length / appState.itemsPerPage);
        const startIdx = (appState.currentPage - 1) * appState.itemsPerPage;
        const paginatedReports = appState.filteredReports.slice(startIdx, startIdx + appState.itemsPerPage);
        
        // Update UI
        elements.reportList.innerHTML = '';
        elements.pageInfo.textContent = `Page ${appState.currentPage} of ${totalPages}`;
        elements.prevPage.disabled = appState.currentPage <= 1;
        elements.nextPage.disabled = appState.currentPage >= totalPages;
        
        if (paginatedReports.length === 0) {
          elements.reportList.innerHTML = '<li class="empty">No reports found</li>';
          return;
        }
        
        paginatedReports.forEach(report => {
          const li = document.createElement('li');
          li.className = `report-item ${report.status}`;
          li.innerHTML = `
            <div class="report-header">
              <span class="report-id">#${report.id.substring(0, 8)}</span>
              <span class="report-type ${report.type}">${report.type}</span>
              <span class="report-status ${report.status}">${report.status}</span>
              <span class="report-date">${utils.formatDate(report.timestamp)}</span>
            </div>
            <div class="report-content">
              <p><strong>Reporter:</strong> ${report.reporterName || 'Anonymous'}</p>
              <p><strong>Reported User:</strong> ${report.reportedUserName || 'Unknown'}</p>
              <p><strong>Details:</strong> ${report.details || 'No details provided'}</p>
            </div>
            <div class="report-actions">
              ${report.status === 'pending' ? 
                '<button class="btn-resolve" data-id="${report.id}">Resolve</button>' : 
                '<button class="btn-view" data-id="${report.id}">View</button>'}
            </div>
          `;
          elements.reportList.appendChild(li);
        });
        
        // Save state
        appState.saveState();
      },
      
      resolveReport: function(reportId) {
        database.ref(`reports/${reportId}`).update({ 
          status: 'resolved',
          resolvedAt: Date.now(),
          resolvedBy: appState.currentUser.uid
        })
          .then(() => utils.showToast('Report resolved successfully'))
          .catch(error => {
            console.error('Error resolving report:', error);
            utils.showToast('Failed to resolve report', 'error');
          });
      },
      
      fetchZones: function() {
        const zonesRef = database.ref('zones');
        zonesRef.on('value', (snapshot) => {
          try {
            const zones = snapshot.val() || {};
            appState.zones = Object.entries(zones).map(([id, zone]) => ({
              id,
              ...zone
            }));
            this.updateZonesDisplay();
          } catch (error) {
            console.error('Error loading zones:', error);
            utils.showToast('Failed to load zones', 'error');
          }
        });
      },
      
      updateZonesDisplay: function() {
        elements.zoneList.innerHTML = '';
        
        if (appState.zones.length === 0) {
          elements.zoneList.innerHTML = '<li class="empty">No zones configured</li>';
          return;
        }
        
        appState.zones.forEach(zone => {
          const li = document.createElement('li');
          li.className = `zone-item ${zone.id === appState.currentZone ? 'active' : ''}`;
          li.innerHTML = `
            <h4>${zone.name}</h4>
            <p>${zone.users || 0} active users</p>
            <button class="btn-view-zone" data-id="${zone.id}">View</button>
          `;
          elements.zoneList.appendChild(li);
        });
        
        // Update active users count for current zone
        if (appState.currentZone !== 'all') {
          const currentZone = appState.zones.find(z => z.id === appState.currentZone);
          if (currentZone) {
            const activeUsers = appState.users.filter(user => 
              user.status === 'active' && 
              user.location && 
              user.location.coordinates &&
              this.isPointInZone(user.location.coordinates, currentZone.boundary)
            ).length;
            
            elements.zoneActiveUsers.textContent = activeUsers;
          }
        }
        
        // Save state
        appState.saveState();
      },
      
      initializeMap: function() {
        if (!appState.mapInitialized) {
          // Initialize map with default coordinates
          elements.monitoringMap = L.map('monitoring-map').setView([14.2307, 120.9752], 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(elements.monitoringMap);
          
          // Add user markers
          this.updateUserMarkers();
          
          appState.mapInitialized = true;
        }
      },
      
      initializeZoneMap: function(zoneId) {
        const zone = appState.zones.find(z => z.id === zoneId);
        if (!zone) return;
        
        // Clear existing map if any
        if (elements.zoneMap) {
          elements.zoneMap.remove();
          elements.zoneMap = null;
        }
        
        // Initialize new map
        elements.zoneMap = L.map('zone-map').setView([zone.center.lat, zone.center.lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(elements.zoneMap);
        
        // Add zone boundary
        if (zone.boundary) {
          L.polygon(zone.boundary, {color: '#3388ff'}).addTo(elements.zoneMap);
        }
        
        // Add users in zone
        appState.users.forEach(user => {
          if (user.location && user.location.coordinates && this.isPointInZone(user.location.coordinates, zone.boundary)) {
            L.marker([user.location.coordinates.lat, user.location.coordinates.lng])
              .addTo(elements.zoneMap)
              .bindPopup(`<b>${user.name || 'Unknown'}</b><br>Status: ${user.status}`);
          }
        });
        
        appState.zoneMapInitialized = true;
      },
      
      isPointInZone: function(point, polygon) {
        if (!polygon || polygon.length < 3) return false;
        
        // Ray-casting algorithm to check if point is in polygon
        let inside = false;
        for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
          const xi = polygon[i][0], yi = polygon[i][1];
          const xj = polygon[j][0], yj = polygon[j][1];
          
          const intersect = ((yi > point.lat) !== (yj > point.lat))
            && (point.lng < (xj - xi) * (point.lat - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
        }
        return inside;
      },
      
      blockUser: function(userId) {
        utils.showConfirmation('Block User', 'Are you sure you want to block this user?')
          .then(confirmed => {
            if (confirmed) {
              database.ref(`users/${userId}`).update({ blocked: true })
                .then(() => utils.showToast('User blocked successfully'))
                .catch(error => {
                  console.error('Error blocking user:', error);
                  utils.showToast('Failed to block user', 'error');
                });
            }
          });
      },
      
      unblockUser: function(userId) {
        utils.showConfirmation('Unblock User', 'Are you sure you want to unblock this user?')
          .then(confirmed => {
            if (confirmed) {
              database.ref(`users/${userId}`).update({ blocked: false })
                .then(() => utils.showToast('User unblocked successfully'))
                .catch(error => {
                  console.error('Error unblocking user:', error);
                  utils.showToast('Failed to unblock user', 'error');
                });
            }
          });
      },
      
      exportReports: function() {
        if (appState.filteredReports.length === 0) {
          utils.showToast('No reports to export', 'info');
          return;
        }
        
        const csvContent = "data:text/csv;charset=utf-8," 
          + "ID,Type,Status,Reporter,Reported User,Details,Timestamp\n"
          + appState.filteredReports.map(report => 
              `${report.id},${report.type},${report.status},"${report.reporterName || 'Anonymous'}","${report.reportedUserName || 'Unknown'}","${report.details || ''}",${utils.formatDate(report.timestamp)}`
            ).join("\n");
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `reports_export_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        utils.showToast('Reports exported successfully');
      }
    };

    // Authentication Functions
    const authFunctions = {
      checkAuthState: function() {
        auth.onAuthStateChanged((user) => {
          if (user) {
            // Check if user is admin
            database.ref(`admins/${user.uid}`).once('value')
              .then((snapshot) => {
                if (snapshot.exists()) {
                  appState.currentUser = {
                    uid: user.uid,
                    email: user.email,
                    isAdmin: true
                  };
                  
                  // Store admin status in localStorage
                  localStorage.setItem('isAdmin', 'true');
                  localStorage.setItem('userEmail', user.email);
                  
                  this.initializeApp();
                } else {
                  utils.showToast('You do not have admin privileges', 'error');
                  this.logout();
                }
              })
              .catch((error) => {
                console.error('Error checking admin status:', error);
                utils.showToast('Authentication error', 'error');
                this.logout();
              });
          } else {
            // Clear localStorage and redirect to login
            localStorage.removeItem('isAdmin');
            localStorage.removeItem('userEmail');
            window.location.href = 'login.html';
          }
        });
      },
      
      logout: function() {
        auth.signOut()
          .then(() => {
            // Clear localStorage on logout
            localStorage.removeItem('isAdmin');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('adminDashboardState');
            window.location.href = 'login.html';
          })
          .catch((error) => {
            console.error('Logout error:', error);
            utils.showToast('Logout failed', 'error');
          });
      }
    };

    // App Initialization
    const app = {
      initializeApp: function() {
        // Check authentication on every page load
        if (!utils.checkAdminAuth()) return;
        
        // Load all data
        firebaseData.fetchUsers();
        firebaseData.fetchNotifications();
        firebaseData.fetchReports();
        firebaseData.fetchZones();
        
        // Set up event listeners
        this.setupEventListeners();
        
        // Show current section based on saved state
        this.showSection(appState.activeTab);
        
        // Update page title
        this.updatePageTitle(appState.activeTab);
      },
      
      setupEventListeners: function() {
        // Navigation
        elements.navLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const section = e.target.getAttribute('data-section');
            appState.activeTab = section;
            this.showSection(section);
            this.updatePageTitle(section);
            appState.saveState();
          });
        });
        
        // Logout
        elements.logoutBtn.addEventListener('click', authFunctions.logout);
        
        // User search
        elements.userSearch.addEventListener('input', utils.debounce(() => {
          firebaseData.updateUsersDisplay();
        }, 300));
        
        // Reports filters
        elements.applyFilters.addEventListener('click', () => {
          appState.currentPage = 1;
          firebaseData.updateReportsDisplay();
        });
        
        elements.clearFilters.addEventListener('click', () => {
          elements.reportTypeFilter.value = 'all';
          elements.reportStatusFilter.value = 'all';
          elements.reportFromDate.value = '';
          elements.reportToDate.value = '';
          appState.currentPage = 1;
          firebaseData.updateReportsDisplay();
        });
        
        elements.exportReports.addEventListener('click', () => {
          firebaseData.exportReports();
        });
        
        // Pagination
        elements.prevPage.addEventListener('click', () => {
          if (appState.currentPage > 1) {
            appState.currentPage--;
            firebaseData.updateReportsDisplay();
          }
        });
        
        elements.nextPage.addEventListener('click', () => {
          const totalPages = Math.ceil(appState.filteredReports.length / appState.itemsPerPage);
          if (appState.currentPage < totalPages) {
            appState.currentPage++;
            firebaseData.updateReportsDisplay();
          }
        });
        
        // Notifications
        elements.notificationIcon.addEventListener('click', (e) => {
          e.stopPropagation();
          elements.notificationDropdown.classList.toggle('show');
        });
        
        elements.markAllRead.addEventListener('click', () => {
          firebaseData.markAllNotificationsRead();
        });
        
        // Close notification dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!elements.notificationIcon.contains(e.target) && 
              !elements.notificationDropdown.contains(e.target)) {
            elements.notificationDropdown.classList.remove('show');
          }
        });
        
        // Delegated event listeners
        document.addEventListener('click', (e) => {
          // Notification mark as read
          if (e.target.closest('.mark-read')) {
            const notificationId = e.target.closest('.mark-read').getAttribute('data-id');
            firebaseData.markNotificationRead(notificationId);
          }
          
          // Report resolve
          if (e.target.closest('.btn-resolve')) {
            const reportId = e.target.closest('.btn-resolve').getAttribute('data-id');
            utils.showConfirmation('Resolve Report', 'Are you sure you want to mark this report as resolved?')
              .then(confirmed => {
                if (confirmed) {
                  firebaseData.resolveReport(reportId);
                }
              });
          }
          
          // View zone
          if (e.target.closest('.btn-view-zone')) {
            const zoneId = e.target.closest('.btn-view-zone').getAttribute('data-id');
            appState.currentZone = zoneId;
            firebaseData.updateZonesDisplay();
            this.showSection('location');
            firebaseData.initializeZoneMap(zoneId);
            this.updatePageTitle('location');
            appState.saveState();
          }
        });
      },
      
      showSection: function(section) {
        // Hide all sections
        elements.contentSections.forEach(sec => {
          sec.classList.remove('active');
        });
        
        // Remove active class from all nav links
        elements.navLinks.forEach(link => {
          link.classList.remove('active');
        });
        
        // Show selected section
        document.getElementById(`${section}-section`).classList.add('active');
        
        // Add active class to current nav link
        document.querySelector(`.nav-link[data-section="${section}"]`).classList.add('active');
        
        appState.activeTab = section;
        
        // Initialize map if showing home section
        if (section === 'home' && !appState.mapInitialized) {
          setTimeout(() => firebaseData.initializeMap(), 500);
        }
        
        // Initialize zone map if showing location section with selected zone
        if (section === 'location' && appState.currentZone !== 'all') {
          setTimeout(() => firebaseData.initializeZoneMap(appState.currentZone), 500);
        }
      },
      
      updatePageTitle: function(section) {
        const titles = {
          'home': 'Dashboard',
          'users': 'User Management',
          'location': 'Location Monitoring',
          'reports': 'Reports Management',
          'settings': 'System Settings'
        };
        
        if (titles[section]) {
          elements.pageTitle.textContent = titles[section];
        }
      }
    };

    // Start the app
    document.addEventListener('DOMContentLoaded', () => {
      authFunctions.checkAuthState();
    });

    // Error handling
    window.addEventListener('error', (event) => {
      console.error('Unhandled error:', event.error);
      utils.showToast('An unexpected error occurred', 'error');
      
      // Log error to server if available
      if (appState.currentUser) {
        database.ref('errors').push({
          error: event.error.toString(),
          stack: event.error.stack,
          userId: appState.currentUser.uid,
          timestamp: Date.now()
        });
      }
    });

    // Cleanup Firebase listeners when page unloads
    window.addEventListener('beforeunload', () => {
      // In a real app, we would keep track of all listeners and detach them here
      database.ref('users').off();
      database.ref('notifications').off();
      database.ref('reports').off();
      database.ref('zones').off();
    });
  </script>
</body>
</html>