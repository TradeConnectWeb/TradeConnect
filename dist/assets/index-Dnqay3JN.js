import{initializeApp as S}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";import{getAuth as D,onAuthStateChanged as P,createUserWithEmailAndPassword as $,signOut as H,sendEmailVerification as F,deleteUser as x}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";import{getDatabase as R,remove as U,ref as B,update as N,get as q}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";import{getFirestore as O,setDoc as z,doc as V,enableIndexedDbPersistence as j,addDoc as L,collection as y,serverTimestamp as v,query as f,where as b,orderBy as G,startAfter as _,getDocs as M}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";import{getStorage as W,ref as Z,uploadBytes as Y,getDownloadURL as J}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();const K={apiKey:"AIzaSyCxaOGeOvHwS5dnPHRTpw3Lwn2surjXP1E",authDomain:"tradeconnect-3c728.firebaseapp.com",projectId:"tradeconnect-3c728",storageBucket:"tradeconnect-3c728.appspot.com",messagingSenderId:"299665603548",appId:"1:299665603548:web:9ff10af44cd41605382d19",databaseURL:"https://tradeconnect-3c728-default-rtdb.asia-southeast1.firebasedatabase.app"},I=S(K),h=D(I),m=O(I),X=W(I),T=R(I),u={init(){document.addEventListener("click",e=>{if(e.target.classList.contains("modal")&&this.close(e.target.id),e.target.closest("[data-modal-close]")){const t=e.target.closest("[data-modal-close]").dataset.modalClose;this.close(t)}}),document.addEventListener("keydown",e=>{if(e.key==="Escape"){const t=document.querySelector('.modal[style*="display: flex"]');t&&this.close(t.id)}})},open(e){const t=document.getElementById(e);if(t){t.style.display="flex",document.body.classList.add("modal-open");const s=t.querySelector("input, textarea, button");s&&s.focus()}},close(e){const t=document.getElementById(e);t&&(t.style.display="none",document.body.classList.remove("modal-open"))},openModal(e){console.warn("openModal() is deprecated. Use ModalManager.open() instead."),this.open(e)}};u.init();window.openModal=u.openModal.bind(u);window.ModalManager=u;const l={show(e,t="success",s=3e3){document.querySelectorAll(".toast").forEach(n=>n.remove());const a=document.createElement("div");a.className=`toast toast-${t}`,a.setAttribute("role","alert"),a.setAttribute("aria-live","assertive"),a.innerHTML=`
        <i class="fas ${t==="success"?"fa-check-circle":"fa-exclamation-circle"}"></i>
        <span>${e}</span>
      `,document.body.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)},s),a.addEventListener("click",()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)})}},c={formatDate(e){if(!e)return"Recently";try{const t=e.toDate?e.toDate():new Date(e);if(isNaN(t.getTime()))return"Invalid date";const a=new Date-t,n=Math.floor(a/1e3),r=Math.floor(n/60),o=Math.floor(r/60),i=Math.floor(o/24);return n<60?"Just now":r<60?`${r} min ago`:o<24?`${o} hour${o===1?"":"s"} ago`:i<7?`${i} day${i===1?"":"s"} ago`:new Intl.DateTimeFormat(navigator.language,{month:"short",day:"numeric",year:i>365?"numeric":void 0}).format(t)}catch(t){return console.error("Date formatting error:",t),"Recently"}},escapeHtml(e){return e?e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""},getCurrentTime(){return new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},debounce(e,t){let s;return(...a)=>{clearTimeout(s),s=setTimeout(()=>e.apply(this,a),t)}},async compressImage(e,t=800,s=.7){return new Promise(a=>{const n=new FileReader;n.onload=r=>{const o=new Image;o.src=r.target.result,o.onload=()=>{const i=document.createElement("canvas"),d=Math.min(t/o.width,1);i.width=o.width*d,i.height=o.height*d,i.getContext("2d").drawImage(o,0,0,i.width,i.height),i.toBlob(E=>a(new File([E],e.name,{type:"image/jpeg"})),"image/jpeg",s)}},n.readAsDataURL(e)})}},g={lastReportTimes:{},async getUserData(e){try{const t=await q(B(T,`users/${e}`));return t.exists()?t.val():null}catch(t){throw console.error("Error getting user data:",t),t}},async updateUserData(e,t){try{return await N(B(T,`users/${e}`),{...t,lastUpdated:v()}),!0}catch(s){throw console.error("Error updating user data:",s),s}},async reportUser(e,t,s){const a=Date.now(),n=this.lastReportTimes[e]||0;if(a-n<24*60*60*1e3)throw new Error("You can only submit one report per day.");try{return await L(y(m,"reports"),{reporterId:e,reportedId:t,reason:s,timestamp:v(),status:"pending"}),this.lastReportTimes[e]=a,!0}catch(r){throw console.error("Error submitting report:",r),r}},async getForumPosts(e={}){try{let t=y(m,"forumPosts");return e.type&&e.type!=="all"&&(t=f(t,b("type","==",e.type))),(await M(t)).docs.map(a=>({id:a.id,...a.data()}))}catch(t){throw console.error("Error getting forum posts:",t),t}},async createForumPost(e){try{return(await L(y(m,"forumPosts"),{...e,createdAt:v(),likes:0,comments:0,status:"active"})).id}catch(t){throw console.error("Error creating forum post:",t),t}},async uploadImage(e,t,s=!0){try{const a=s?await c.compressImage(e):e,n=Z(X,`${t}/${Date.now()}_${a.name}`);return await Y(n,a),J(n)}catch(a){throw console.error("Error uploading image:",a),a}},async getMarketplaceItems(e={},t=null,s=10){try{let a=f(y(m,"marketplaceItems"));e.category&&e.category!=="All Items"&&(a=f(a,b("category","==",e.category))),e.userId&&(a=f(a,b("uid","==",e.userId))),a=f(a,G("createdAt","desc"),s(s)),t&&(a=f(a,_(t)));const n=await M(a);if(!n||!n.docs)throw new Error("Invalid snapshot returned");return{items:n.docs.map(r=>{const o=r.data();return{id:r.id,title:o.title||"Untitled",price:o.price||0,images:o.images||[],isSelling:o.isSelling||!1,createdAt:o.createdAt||v(),views:o.views||0,category:o.category||"Other"}}),lastDoc:n.docs[n.docs.length-1]||null}}catch(a){throw console.error("Database Error:",a),new Error("Failed to load marketplace items. Please try again later.")}},async createMarketplaceItem(e){try{return(await L(y(m,"marketplaceItems"),{...e,createdAt:v(),views:0})).id}catch(t){throw console.error("Error creating marketplace item:",t),t}}},Q=3,ee=1e3;P(h,async e=>{const t=async(s=0)=>{try{if(e){if(!e.emailVerified&&e.email&&await F(e),!await Promise.race([g.getUserData(e.uid),new Promise((n,r)=>setTimeout(()=>r(new Error("Timeout loading user data")),5e3))])){u.open("signupModal");return}k.loadProfile()}else window.location.href="login.html"}catch(a){if(s<Q)return console.log(`Retrying auth state (attempt ${s+1})`),await new Promise(n=>setTimeout(n,ee*(s+1))),t(s+1);console.error("Auth state error:",a),l.show("Error loading user data. Please refresh.","error")}};await t()});async function te(){try{await j(m,{forceOwnership:!0}),console.log("Offline persistence enabled")}catch(e){e.code==="failed-precondition"?console.warn("Offline persistence already enabled in another tab"):e.code==="unimplemented"?console.warn("Offline persistence not supported in this browser"):console.error("Offline persistence error:",e)}}const ne={init(){document.querySelectorAll(".image-upload-box").forEach(e=>{const t=e.querySelector('input[type="file"]'),s=e.querySelector(".image-preview"),a=e.querySelector(".image-upload-text");!t||!s||!a||(t.addEventListener("change",n=>this.handleFileSelect(n,s,a,e)),e.addEventListener("dragover",n=>{n.preventDefault(),e.style.borderColor="var(--primary)",e.style.backgroundColor="rgba(110, 142, 251, 0.1)"}),e.addEventListener("dragleave",()=>{e.style.borderColor="",e.style.backgroundColor=""}),e.addEventListener("drop",n=>{if(n.preventDefault(),e.style.borderColor="",e.style.backgroundColor="",n.dataTransfer.files.length){t.files=n.dataTransfer.files;const r=new Event("change");t.dispatchEvent(r)}}))})},handleFileSelect(e,t,s,a){if(e.target.files&&e.target.files[0]){const n=e.target.files[0];if(!["image/jpeg","image/png","image/webp"].includes(n.type)){l.show("Invalid file type. Only JPEG, PNG, and WebP are allowed.","error");return}if(n.size>5*1024*1024){l.show("File too large. Maximum size is 5MB.","error");return}const o=new FileReader;o.onload=i=>{t.src=i.target.result,t.style.display="block",s.style.display="none",this.addRemoveButton(a,t,s,e.target)},o.readAsDataURL(n)}},addRemoveButton(e,t,s,a){const n=e.querySelector(".remove-image");n&&n.remove();const r=document.createElement("button");r.className="remove-image",r.innerHTML="&times;",r.setAttribute("aria-label","Remove image"),r.style.cssText=`
        position: absolute;
        top: 5px;
        right: 5px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      `,r.addEventListener("click",o=>{o.stopPropagation(),t.src="",t.style.display="none",s.style.display="flex",a.value="",r.remove()}),e.appendChild(r)}},ae={validate(e){const t=document.getElementById(e);if(!t)return!1;const s=t.querySelectorAll("[required]");let a=!0;return s.forEach(n=>{n.value.trim()?(this.clearError(n),n.type==="email"&&!this.validateEmail(n.value)&&(this.showError(n,"Please enter a valid email"),a=!1),n.type==="password"&&n.value.length<6&&(this.showError(n,"Password must be at least 6 characters"),a=!1)):(this.showError(n,"This field is required"),a=!1)}),a},validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)},showError(e,t){if(e.style.borderColor="var(--accent)",!e.nextElementSibling||!e.nextElementSibling.classList.contains("error-message")){const s=document.createElement("div");s.className="error-message",s.textContent=t,s.style.cssText=`
          color: var(--accent);
          font-size: 12px;
          margin-top: 5px;
        `,e.after(s)}},clearError(e){e.style.borderColor="",e.nextElementSibling&&e.nextElementSibling.classList.contains("error-message")&&e.nextElementSibling.remove()}},se={lastVisibleDoc:null,currentCategory:"All Items",isLoading:!1,init(){this.setupEventListeners(),this.loadListings()},setupEventListeners(){document.querySelectorAll(".category-btn").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".category-btn").forEach(s=>s.classList.remove("active")),t.classList.add("active"),this.currentCategory=t.dataset.category,this.loadListings()})});const e=document.getElementById("tradeOrSell");e&&e.addEventListener("change",()=>{const t=document.getElementById("priceInput");t&&(t.style.display=e.checked?"block":"none",document.getElementById("itemPrice").required=e.checked)}),this.initInfiniteScroll()},initInfiniteScroll(){const e=new IntersectionObserver(s=>{s[0].isIntersecting&&this.lastVisibleDoc&&!this.isLoading&&this.loadMoreListings()},{threshold:.1}),t=document.createElement("div");t.id="scrollSentinel",document.getElementById("marketplaceListings").appendChild(t),e.observe(t)},async loadListings(e=!1){if(this.isLoading)return;this.isLoading=!0;const t=document.getElementById("marketplaceListings");try{e||(this.lastVisibleDoc=null,t.innerHTML=`
            <div class="loading-spinner" aria-live="polite">
              <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> 
              Loading listings...
            </div>
          `);const{items:s,lastDoc:a}=await g.getMarketplaceItems({category:this.currentCategory},this.lastVisibleDoc);if(this.lastVisibleDoc=a,s.length===0&&!e){t.innerHTML=`
            <div class="no-listings" aria-live="polite">
              <i class="fas fa-box-open" aria-hidden="true"></i>
              <p>No listings found in this category</p>
            </div>
          `;return}this.renderListings(s,e),this.updateLoadMoreButton(!!a)}catch(s){console.error("Error loading listings:",s),l.show("Failed to load listings","error")}finally{this.isLoading=!1}},async loadMoreListings(){await this.loadListings(!0)},renderListings(e,t=!1){const s=document.getElementById("marketplaceListings");t||(s.innerHTML=""),e.forEach(a=>{const n=document.createElement("div");n.className="product-card",n.dataset.id=a.id,n.setAttribute("role","article"),n.innerHTML=`
          <span class="product-badge ${a.isSelling?"":"trade"}" aria-label="${a.isSelling?"For Sale":"For Trade"}">
            ${a.isSelling?"For Sale":"For Trade"}
          </span>
          <img src="${a.images[0]||"https://placehold.co/250"}" 
               alt="${c.escapeHtml(a.title)}" 
               loading="lazy"
               onerror="this.src='https://placehold.co/250'">
          <div class="product-info">
            <h3>${c.escapeHtml(a.title)}</h3>
            <div class="price">${a.isSelling?`‚Ç±${a.price.toFixed(2)}`:"Trade Only"}</div>
            <div class="location">
              <i class="fas fa-map-marker-alt" aria-hidden="true"></i> Bulihan, Silang, Cavite
            </div>
            <div class="product-meta">
              <span>${c.formatDate(a.createdAt)}</span>
              <span><i class="fas fa-eye" aria-hidden="true"></i> ${a.views||0}</span>
            </div>
          </div>
        `,n.addEventListener("click",()=>{this.viewListingDetails(a)}),n.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),this.viewListingDetails(a))}),n.tabIndex=0,s.appendChild(n)})},updateLoadMoreButton(e){let t=document.getElementById("loadMoreBtn");e&&!t?(t=document.createElement("button"),t.id="loadMoreBtn",t.className="load-more-btn",t.textContent="Load More",t.addEventListener("click",()=>this.loadMoreListings()),document.getElementById("marketplaceContainer").appendChild(t)):!e&&t&&t.remove()},viewListingDetails(e){console.log("Viewing listing:",e)}},re={init(){this.setupEventListeners(),this.loadPosts()},setupEventListeners(){const e=document.getElementById("postTypeFilter");e&&e.addEventListener("change",()=>this.loadPosts());const t=document.getElementById("postType");t&&t.addEventListener("change",()=>{const a=document.getElementById("paymentMethodField"),n=document.getElementById("gcashField");a&&n&&(a.style.display=t.value==="scam"||t.value==="review"?"block":"none",n.style.display="none")});const s=document.getElementById("paymentMethod");s&&s.addEventListener("change",()=>{const a=document.getElementById("gcashField");a&&(a.style.display=s.value==="gcash"?"block":"none")})},async loadPosts(){const e=document.getElementById("forumPostsContainer");if(e)try{e.innerHTML=`
          <div class="loading-spinner" aria-live="polite">
            <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> 
            Loading posts...
          </div>
        `;const t=document.getElementById("postTypeFilter"),s=t?t.value:"all",a=await Promise.race([g.getForumPosts({type:s==="all"?null:s}),new Promise((n,r)=>setTimeout(()=>r(new Error("Request timeout")),1e4))]);if(!a||a.length===0){e.innerHTML=`
            <div class="no-posts" aria-live="polite">
              <i class="fas fa-comment-slash" aria-hidden="true"></i>
              <p>No posts found</p>
            </div>
          `;return}e.innerHTML="",a.forEach(n=>{if(!n.id||!n.type||!n.title||!n.content){console.warn("Invalid post data:",n);return}const r=document.createElement("div");r.className="forum-post",r.dataset.id=n.id,r.setAttribute("role","article");const o={review:"‚úÖ",scam:"‚ö†Ô∏è",question:"üí¨",buy:"üîé"}[n.type]||"";r.innerHTML=`
            <div class="post-header">
              <span class="post-type">${o} ${n.type.toUpperCase()}</span>
              <span class="post-date">${c.formatDate(n.createdAt)}</span>
            </div>
            <h3 class="post-title">${c.escapeHtml(n.title)}</h3>
            <p class="post-content">${c.escapeHtml(n.content)}</p>
            
            ${n.location?`
              <div class="post-meta">
                <i class="fas fa-map-marker-alt" aria-hidden="true"></i> 
                ${c.escapeHtml(n.location)}
              </div>
            `:""}
            
            ${n.imageUrl?`
              <img src="${c.escapeHtml(n.imageUrl)}" 
                   class="post-image" 
                   alt="Post image" 
                   loading="lazy"
                   onerror="this.style.display='none'">
            `:""}
            
            <div class="post-actions">
              <button class="comment-btn" aria-label="Comment">
                <i class="far fa-comment" aria-hidden="true"></i> 
                Comment (${n.comments||0})
              </button>
              <button class="like-btn" aria-label="Like">
                <i class="far fa-heart" aria-hidden="true"></i> 
                Like (${n.likes||0})
              </button>
            </div>
          `,r.addEventListener("keydown",i=>{(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),this.viewPostDetails(n))}),r.tabIndex=0,e.appendChild(r)})}catch(t){console.error("Error loading forum posts:",t),e.innerHTML=`
          <div class="error-state" aria-live="polite">
            <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
            <p>Failed to load posts. Please try again.</p>
            <button onclick="ForumManager.loadPosts()">Retry</button>
          </div>
        `}},viewPostDetails(e){console.log("Viewing post:",e)}},k={init(){this.setupEventListeners(),this.loadProfile()},setupEventListeners(){const e=document.getElementById("profile-upload");e&&e.addEventListener("change",a=>{const n=document.getElementById("preview-img"),r=document.getElementById("userAvatar");if(n&&r){const o=new FileReader;o.onload=function(){n.src=o.result,r.src=o.result},o.readAsDataURL(a.target.files[0])}});const t=document.querySelector(".save-btn");t&&t.addEventListener("click",()=>this.saveProfile());const s=document.querySelector(".delete-btn");s&&s.addEventListener("click",()=>this.confirmDelete())},async loadProfile(){const e=h.currentUser;if(e)try{const t=await g.getUserData(e.uid);if(!t)return;const s={userName:t.username||"User",userEmail:e.email||"No email",userZone:t.zone||"No zone",userAvatar:t.photoURL||"https://placehold.co/40",nicknameInput:t.username||"",zoneSelect:t.zone||"",contactInput:t.contact||"",gcashInput:t.gcash||"",previewImg:t.photoURL||"https://placehold.co/120"};Object.entries(s).forEach(([a,n])=>{const r=document.getElementById(a);r&&(a.endsWith("Avatar")||a.endsWith("Img")?r.src=n:(r.textContent=n,r.value=n))}),t.isNewUser&&setTimeout(()=>u.open("welcomeModal"),1e3)}catch(t){console.error("Error loading profile:",t),l.show("Error loading profile data","error")}},async saveProfile(){const e=h.currentUser;if(!e)return;const t=document.getElementById("nickname").value,s=document.getElementById("zone").value,a=document.getElementById("contact").value,n=document.getElementById("gcash").value,r=document.getElementById("profile-upload").files[0],o=document.querySelector(".save-btn");if(o)try{o.disabled=!0,o.classList.add("loading"),o.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...';const i={username:t,zone:s,contact:a,gcash:n};if(r){const A=await g.uploadImage(r,`profilePictures/${e.uid}`);i.photoURL=A}await g.updateUserData(e.uid,i);const d=document.getElementById("userName"),p=document.getElementById("userZone"),E=document.getElementById("userAvatar");d&&(d.textContent=t),p&&(p.textContent=s),E&&i.photoURL&&(E.src=i.photoURL),l.show("Profile updated successfully!"),u.close("settingsModal")}catch(i){console.error("Error updating profile:",i),l.show("Failed to update profile. Please try again.","error")}finally{o.disabled=!1,o.classList.remove("loading"),o.innerHTML='<i class="fas fa-save"></i> Save Changes'}},confirmDelete(){confirm("Are you sure you want to DELETE your account? This action cannot be undone.")&&this.deleteAccount()},async deleteAccount(){const e=h.currentUser;if(!e)return;const t=document.querySelector(".delete-btn");if(t)try{t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Deleting...',await U(B(T,`users/${e.uid}`)),await x(e),l.show("Account deleted successfully."),window.location.href="login.html"}catch(s){console.error("Error deleting account:",s),l.show("Failed to delete account. Please try again.","error"),t.disabled=!1,t.innerHTML='<i class="fas fa-trash-alt"></i> Delete Account'}}},oe={lastMessageTime:0,MESSAGE_RATE_LIMIT:1e3,init(){this.setupEventListeners()},setupEventListeners(){const e=document.getElementById("sendMessage");e&&e.addEventListener("click",()=>this.sendMessage());const t=document.getElementById("messageInput");t&&t.addEventListener("keydown",s=>{s.key==="Enter"&&this.sendMessage()})},sendMessage(){const e=Date.now();if(e-this.lastMessageTime<this.MESSAGE_RATE_LIMIT){l.show("Please wait before sending another message","warning");return}this.lastMessageTime=e;const t=document.getElementById("messageInput"),s=document.getElementById("chatMessages");if(!t||!s)return;const a=t.value.trim();if(!a){l.show("Message cannot be empty","warning");return}if(a.length>500){l.show("Message is too long (max 500 characters)","warning");return}const n=document.createElement("div");n.className="message sent",n.setAttribute("role","log"),n.setAttribute("aria-live","polite"),n.innerHTML=`
        <div class="message-content">
          <p>${c.escapeHtml(a)}</p>
          <span class="message-time">${c.getCurrentTime()}</span>
        </div>
      `,s.appendChild(n),t.value="",s.scrollTop=s.scrollHeight,setTimeout(()=>{const r=document.createElement("div");r.className="message received",r.setAttribute("role","log"),r.setAttribute("aria-live","polite"),r.innerHTML=`
          <div class="message-content">
            <p>Thanks for your message! Our team will respond shortly.</p>
            <span class="message-time">${c.getCurrentTime()}</span>
          </div>
        `,s.appendChild(r),s.scrollTop=s.scrollHeight},1500)}},ie={init(){this.renderCategories(),this.setupEventListeners()},renderCategories(){const e=document.getElementById("helpCategories");e&&(e.innerHTML="",w.categories.forEach(t=>{const s=document.createElement("div");s.className="category-card",s.dataset.categoryId=t.id,s.setAttribute("role","button"),s.tabIndex=0,s.innerHTML=`
          <i class="${t.icon}" aria-hidden="true"></i>
          <h3>${t.title}</h3>
          <p>${t.description}</p>
        `,e.appendChild(s)}))},setupEventListeners(){document.addEventListener("click",a=>{const n=a.target.closest(".category-card");if(n){const o=n.dataset.categoryId;this.renderArticles(o),document.getElementById("helpArticles").scrollIntoView({behavior:"smooth"})}const r=a.target.closest(".article-card");r&&this.renderArticleDetail(r.dataset.articleId)});const e=document.getElementById("backToList");e&&e.addEventListener("click",()=>{document.getElementById("articleDetail").style.display="none",document.getElementById("helpArticles").style.display="block",document.getElementById("helpCategories").style.display="flex"});const t=document.getElementById("searchHelpBtn");t&&t.addEventListener("click",()=>{const a=document.getElementById("helpSearch").value;this.renderArticles(null,a)});const s=document.getElementById("helpSearch");s&&s.addEventListener("keyup",a=>{if(a.key==="Enter"){const n=document.getElementById("helpSearch").value;this.renderArticles(null,n)}}),document.querySelectorAll(".feedback-btn").forEach(a=>{a.addEventListener("click",()=>{document.getElementById("articleDetail").dataset.articleId;const n=a.dataset.helpful==="yes";l.show(`Thank you for your feedback! Article marked as ${n?"helpful":"not helpful"}`)})})},renderArticles(e=null,t=""){const s=document.getElementById("helpArticles");if(!s)return;s.innerHTML="";let a=w.articles;if(e&&(a=a.filter(n=>n.category===e)),t){const n=t.toLowerCase();a=a.filter(r=>r.title.toLowerCase().includes(n)||r.content.toLowerCase().includes(n))}if(a.length===0){s.innerHTML=`
          <div class="no-articles" aria-live="polite">
            <i class="fas fa-info-circle" aria-hidden="true"></i>
            <p>No articles found</p>
          </div>
        `;return}a.forEach(n=>{const r=document.createElement("div");r.className="article-card",r.dataset.articleId=n.id,r.setAttribute("role","button"),r.tabIndex=0,r.innerHTML=`
          <h3>${n.title}</h3>
          <div class="article-meta">
            <span>${this.getCategoryName(n.category)}</span>
            <span> ‚Ä¢ ${c.formatDate(n.date)}</span>
          </div>
        `,s.appendChild(r)})},renderArticleDetail(e){const t=w.articles.find(r=>r.id===e);if(!t)return;const s=document.getElementById("helpArticles"),a=document.getElementById("helpCategories"),n=document.getElementById("articleDetail");s&&a&&n&&(s.style.display="none",a.style.display="none",n.style.display="block",document.getElementById("articleTitle").textContent=t.title,document.getElementById("articleCategory").textContent=this.getCategoryName(t.category),document.getElementById("articleDate").textContent=c.formatDate(t.date),document.getElementById("articleContent").innerHTML=t.content)},getCategoryName(e){const t=w.categories.find(s=>s.id===e);return t?t.title:""}};document.addEventListener("DOMContentLoaded",function(){u.init(),ne.init(),document.getElementById("marketplaceListings")&&se.init(),document.getElementById("forumPostsContainer")&&re.init(),document.getElementById("userAvatar")&&k.init(),document.getElementById("chatMessages")&&oe.init(),document.getElementById("helpCategories")&&ie.init(),te();function e(){const t={"ES6 Promise":"Promise"in window,"Fetch API":"fetch"in window,IntersectionObserver:"IntersectionObserver"in window,"Web Storage":"localStorage"in window,Internationalization:"Intl"in window},s=Object.entries(t).filter(([a,n])=>!n).map(([a])=>a);if(s.length>0){const a=`Your browser is missing: ${s.join(", ")}. 
          Some features may not work properly. Consider updating your browser.`;l.show(a,"warning",1e4),console.warn("Missing browser features:",s)}}e()});const w={categories:[{id:"getting-started",title:"Getting Started",icon:"fas fa-book",description:"Learn how to begin using TradeConnect"},{id:"trading",title:"Trading Guide",icon:"fas fa-exchange-alt",description:"How to trade items in the marketplace"},{id:"buying-selling",title:"Buying & Selling",icon:"fas fa-money-bill-wave",description:"Guide to buying and selling items"},{id:"messages",title:"Messages",icon:"fas fa-comments",description:"How to use the messaging system"},{id:"community",title:"Community Forum",icon:"fas fa-users",description:"Using the community features"},{id:"account",title:"Account & Settings",icon:"fas fa-cog",description:"Manage your account settings"}],articles:[{id:"what-is-tradeconnect",category:"getting-started",title:"What is TradeConnect?",content:"<p>TradeConnect is a web app that allows users in Barangay Bulihan, Silang, Cavite (Zones 1-11) to trade, buy, and sell items safely and directly.</p>",date:"2023-10-15",helpful:42,notHelpful:3},{id:"how-to-create-account",category:"getting-started",title:"How to create an account?",content:"<p>Go to the registration page, fill in your details, and verify your number to get started.</p>",date:"2023-10-15",helpful:38,notHelpful:2},{id:"how-to-trade",category:"trading",title:"How to trade?",content:'<p>Click on a post with a "Trade" label. It will open a direct chat to negotiate the swap.</p>',date:"2023-10-16",helpful:28,notHelpful:1},{id:"how-to-buy",category:"buying-selling",title:"How to buy items?",content:'<p>Click "Buy" on a listing and proceed directly to payment (GCash or Cash method).</p>',date:"2023-10-17",helpful:35,notHelpful:4}]};var C;(C=document.getElementById("signupForm"))==null||C.addEventListener("submit",async e=>{if(e.preventDefault(),!ae.validate("signupForm"))return;const t=document.getElementById("signupName").value,s=document.getElementById("signupEmail").value,a=document.getElementById("signupPassword").value,n=document.getElementById("signupZone").value,r=document.getElementById("signupContact").value,o=document.getElementById("signupPhoto").files[0];try{const d=(await $(h,s,a)).user.uid;let p="";o&&(p=await g.uploadImage(o,`profilePictures/${d}`)),await z(V(m,"users",d),{username:t,email:s,zone:n,contact:r,photoURL:p,isNewUser:!0}),window.location.href="index.html"}catch(i){console.error("Signup failed:",i),l.show(`Signup failed: ${i.message}`,"error")}});window.logout=async function(){try{await H(h),window.location.href="login.html"}catch(e){console.error("Logout failed:",e),l.show("Failed to logout. Please try again.","error")}};
