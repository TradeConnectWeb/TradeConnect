import{initializeApp as S}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";import{getAuth as T,onAuthStateChanged as A,signOut as f,sendEmailVerification as k}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";import{getDatabase as $,update as P,ref as h,get as N,set as O}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";import{getFirestore as R,enableIndexedDbPersistence as U,addDoc as B,collection as I,serverTimestamp as g,query as m,orderBy as x,where as b,startAfter as H,getDocs as C}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";import{getStorage as F,ref as q,uploadBytes as z,getDownloadURL as V}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function o(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(r){if(r.ep)return;r.ep=!0;const s=o(r);fetch(r.href,s)}})();const _={apiKey:"AIzaSyCxaOGeOvHwS5dnPHRTpw3Lwn2surjXP1E",authDomain:"tradeconnect-3c728.firebaseapp.com",projectId:"tradeconnect-3c728",storageBucket:"tradeconnect-3c728.appspot.com",messagingSenderId:"299665603548",appId:"1:299665603548:web:9ff10af44cd41605382d19",databaseURL:"https://tradeconnect-3c728-default-rtdb.asia-southeast1.firebasedatabase.app"},p=S(_),d=T(p),y=R(p),j=F(p),w=$(p),c={init(){document.addEventListener("click",t=>{if(t.target.classList.contains("modal")&&this.close(t.target.id),t.target.closest("[data-modal-close]")){const e=t.target.closest("[data-modal-close]").dataset.modalClose;this.close(e)}}),document.addEventListener("keydown",t=>{if(t.key==="Escape"){const e=document.querySelector('.modal[style*="display: flex"]');e&&this.close(e.id)}}),document.querySelectorAll(".modal-close").forEach(t=>{t.addEventListener("click",e=>{const o=e.target.closest(".modal");o&&this.close(o.id)})})},open(t){const e=document.getElementById(t);if(e){e.style.display="flex",document.body.classList.add("modal-open");const o=e.querySelector("input, textarea, button");o&&o.focus()}},close(t){const e=document.getElementById(t);e&&(e.style.display="none",document.body.classList.remove("modal-open"))}};c.init();window.ModalManager=c;window.closeModal=c.close.bind(c);window.openModal=c.open.bind(c);const l={show(t,e="success",o=3e3){document.querySelectorAll(".toast").forEach(r=>r.remove());const a=document.createElement("div");a.className=`toast toast-${e}`,a.setAttribute("role","alert"),a.setAttribute("aria-live","assertive"),a.innerHTML=`
        <i class="fas ${e==="success"?"fa-check-circle":"fa-exclamation-circle"}"></i>
        <span>${t}</span>
      `,document.body.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)},o),a.addEventListener("click",()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)})}},u={formatDate(t){if(!t)return"Recently";try{const e=t.toDate?t.toDate():new Date(t);if(isNaN(e.getTime()))return"Invalid date";const a=new Date-e,r=Math.floor(a/1e3),s=Math.floor(r/60),i=Math.floor(s/60),n=Math.floor(i/24);return r<60?"Just now":s<60?`${s} min ago`:i<24?`${i} hour${i===1?"":"s"} ago`:n<7?`${n} day${n===1?"":"s"} ago`:new Intl.DateTimeFormat(navigator.language,{month:"short",day:"numeric",year:n>365?"numeric":void 0}).format(e)}catch(e){return console.error("Date formatting error:",e),"Recently"}},escapeHtml(t){return t?t.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""},getCurrentTime(){return new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},debounce(t,e){let o;return(...a)=>{clearTimeout(o),o=setTimeout(()=>t.apply(this,a),e)}},async compressImage(t,e=800,o=.7){return new Promise(a=>{const r=new FileReader;r.onload=s=>{const i=new Image;i.src=s.target.result,i.onload=()=>{const n=document.createElement("canvas"),L=Math.min(e/i.width,1);n.width=i.width*L,n.height=i.height*L,n.getContext("2d").drawImage(i,0,0,n.width,n.height),n.toBlob(M=>a(new File([M],t.name,{type:"image/jpeg"})),"image/jpeg",o)}},r.readAsDataURL(t)})}},E={async getUserData(t){try{const e=await N(h(w,`users/${t}`));if(!e.exists()){const o={username:"New User",zone:"",contact:"",gcash:"",photoURL:"https://placehold.co/120",isNewUser:!0,lastUpdated:g()};return await O(h(w,`users/${t}`),o),o}return e.val()}catch(e){throw console.error("Error getting user data:",e),e.code==="PERMISSION_DENIED"&&(l.show("Please sign in to access your data","error"),await f(d),window.location.href="login.html"),e}},async updateUserData(t,e){try{return await P(h(w,`users/${t}`),{...e,lastUpdated:g()}),!0}catch(o){throw console.error("Error updating user data:",o),o.code==="PERMISSION_DENIED"&&(l.show("You don't have permission to update this data","error"),await f(d),window.location.href="login.html"),o}},async getMarketplaceItems(t={},e=null,o=10){try{let a=m(I(y,"marketplaceItems"),x("createdAt","desc"),o(o));t.category&&t.category!=="All Items"&&(a=m(a,b("category","==",t.category))),t.userId&&(a=m(a,b("uid","==",t.userId))),e&&(a=m(a,H(e)));const r=await C(a);if(!r||!r.docs)throw new Error("Invalid snapshot returned");return{items:r.docs.map(s=>{const i=s.data();return{id:s.id,title:i.title||"Untitled",price:i.price||0,images:i.images||[],isSelling:i.isSelling||!1,createdAt:i.createdAt||g(),views:i.views||0,category:i.category||"Other"}}),lastDoc:r.docs[r.docs.length-1]||null}}catch(a){throw console.error("Database Error:",a),new Error("Failed to load marketplace items. Please try again later.")}},async createMarketplaceItem(t){try{return(await B(I(y,"marketplaceItems"),{...t,createdAt:g(),views:0})).id}catch(e){throw console.error("Error creating marketplace item:",e),e}},async uploadImage(t,e,o=!0){try{const a=o?await u.compressImage(t):t,r=q(j,`${e}/${Date.now()}_${a.name}`);return await z(r,a),V(r)}catch(a){throw console.error("Error uploading image:",a),a}}},Y=3,K=1e3;A(d,async t=>{const e=async(o=0)=>{try{if(t){!t.emailVerified&&t.email&&(await k(t),l.show("Verification email sent. Please verify your email.","info"));try{if(!await E.getUserData(t.uid)){c.open("signupModal");return}typeof v.loadProfile=="function"&&v.loadProfile()}catch(a){if(a.code==="PERMISSION_DENIED"){await f(d),window.location.href="login.html";return}throw a}}else window.location.href="login.html"}catch(a){if(o<Y)return console.log(`Retrying auth state (attempt ${o+1})`),await new Promise(r=>setTimeout(r,K*(o+1))),e(o+1);console.error("Auth state error:",a),l.show("Error loading user data. Please refresh.","error")}};await e()});const D={lastVisibleDoc:null,currentCategory:"All Items",isLoading:!1,hasMoreItems:!0,init(){this.setupEventListeners(),this.loadListings()},setupEventListeners(){document.querySelectorAll(".category-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".category-btn").forEach(o=>o.classList.remove("active")),e.classList.add("active"),this.currentCategory=e.dataset.category,this.loadListings()})});const t=document.getElementById("tradeOrSell");t&&t.addEventListener("change",()=>{const e=document.getElementById("priceInput");e&&(e.style.display=t.checked?"block":"none",document.getElementById("itemPrice").required=t.checked)}),window.addEventListener("scroll",u.debounce(()=>{if(this.isLoading||!this.hasMoreItems)return;const{scrollTop:e,scrollHeight:o,clientHeight:a}=document.documentElement;e+a>=o-100&&this.loadListings(!0)},200))},async loadListings(t=!1){if(this.isLoading)return;this.isLoading=!0;const e=document.getElementById("marketplaceListings");try{if(!t)this.lastVisibleDoc=null,this.hasMoreItems=!0,e.innerHTML=`
            <div class="loading-spinner" aria-live="polite">
              <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> 
              Loading listings...
            </div>
          `;else{const r=document.createElement("div");r.className="loading-spinner",r.innerHTML='<i class="fas fa-spinner fa-spin" aria-hidden="true"></i> Loading more...',e.appendChild(r)}const{items:o,lastDoc:a}=await E.getMarketplaceItems({category:this.currentCategory},this.lastVisibleDoc);if(this.lastVisibleDoc=a,this.hasMoreItems=o.length>0,o.length===0&&!t){e.innerHTML=`
            <div class="no-listings" aria-live="polite">
              <i class="fas fa-box-open" aria-hidden="true"></i>
              <p>No listings found in this category</p>
            </div>
          `;return}this.renderListings(o,t)}catch(o){console.error("Error loading listings:",o),l.show("Failed to load listings","error"),t||(e.innerHTML=`
            <div class="error-state" aria-live="polite">
              <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
              <p>Failed to load listings. Please try again.</p>
              <button onclick="MarketplaceManager.loadListings()">Retry</button>
            </div>
          `)}finally{document.querySelectorAll(".loading-spinner").forEach(o=>o.remove()),this.isLoading=!1}},renderListings(t,e=!1){const o=document.getElementById("marketplaceListings");e||(o.innerHTML=""),t.forEach(a=>{const r=document.createElement("div");r.className="product-card",r.dataset.id=a.id,r.setAttribute("role","article"),r.tabIndex=0,r.innerHTML=`
          <span class="product-badge ${a.isSelling?"":"trade"}" aria-label="${a.isSelling?"For Sale":"For Trade"}">
            ${a.isSelling?"For Sale":"For Trade"}
          </span>
          <img src="${a.images[0]||"https://placehold.co/250"}" 
               alt="${u.escapeHtml(a.title)}" 
               loading="lazy"
               onerror="this.src='https://placehold.co/250'">
          <div class="product-info">
            <h3>${u.escapeHtml(a.title)}</h3>
            <div class="price">${a.isSelling?`₱${a.price.toFixed(2)}`:"Trade Only"}</div>
            <div class="location">
              <i class="fas fa-map-marker-alt" aria-hidden="true"></i> Bulihan, Silang, Cavite
            </div>
            <div class="product-meta">
              <span>${u.formatDate(a.createdAt)}</span>
              <span><i class="fas fa-eye" aria-hidden="true"></i> ${a.views||0}</span>
            </div>
          </div>
        `,r.addEventListener("click",()=>{this.viewListingDetails(a)}),r.addEventListener("keydown",s=>{(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),this.viewListingDetails(a))}),o.appendChild(r)})},viewListingDetails(t){console.log("Viewing listing:",t)}},v={async loadProfile(){const t=d.currentUser;if(t)try{const e=await E.getUserData(t.uid);if(!e)return;const o={userName:e.username||"User",userEmail:t.email||"No email",userZone:e.zone||"No zone",userAvatar:e.photoURL||"https://placehold.co/40",nicknameInput:e.username||"",zoneSelect:e.zone||"",contactInput:e.contact||"",gcashInput:e.gcash||"",previewImg:e.photoURL||"https://placehold.co/120"};Object.entries(o).forEach(([a,r])=>{const s=document.getElementById(a);s&&(a.endsWith("Avatar")||a.endsWith("Img")?s.src=r:(s.textContent=r,s.value=r))}),e.isNewUser&&setTimeout(()=>c.open("welcomeModal"),1e3)}catch(e){console.error("Error loading profile:",e),l.show("Error loading profile data","error")}}};document.addEventListener("DOMContentLoaded",function(){c.init(),document.getElementById("marketplaceListings")&&D.init(),document.getElementById("userAvatar")&&v.loadProfile(),async function(){try{await U(y,{forceOwnership:!0}),console.log("Offline persistence enabled")}catch(t){t.code==="failed-precondition"?console.warn("Offline persistence already enabled in another tab"):t.code==="unimplemented"?console.warn("Offline persistence not supported in this browser"):console.error("Offline persistence error:",t)}}()});window.logout=async function(){try{await f(d),window.location.href="login.html"}catch(t){console.error("Logout failed:",t),l.show("Failed to logout. Please try again.","error")}};window.MarketplaceManager=D;
