import{initializeApp as A}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";import{getAuth as S,signOut as f,sendEmailVerification as T,onAuthStateChanged as R}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";import{getDatabase as P,get as $,ref as y,set as k}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";import{getFirestore as N,enableIndexedDbPersistence as O,query as g,collection as U,orderBy as B,where as E,startAfter as x,getDocs as F,serverTimestamp as v}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";import{getStorage as H,ref as q,uploadBytes as z,getDownloadURL as _}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function r(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=r(o);fetch(o.href,i)}})();const C={apiKey:"AIzaSyCxaOGeOvHwS5dnPHRTpw3Lwn2surjXP1E",authDomain:"tradeconnect-3c728.firebaseapp.com",projectId:"tradeconnect-3c728",storageBucket:"tradeconnect-3c728.appspot.com",messagingSenderId:"299665603548",appId:"1:299665603548:web:9ff10af44cd41605382d19",databaseURL:"https://tradeconnect-3c728-default-rtdb.asia-southeast1.firebasedatabase.app"},m=A(C),u=S(m),I=N(m),V=H(m),L=P(m),c={init(){document.addEventListener("click",t=>{if(t.target.classList.contains("modal")&&this.close(t.target.id),t.target.closest("[data-modal-close]")){const e=t.target.closest("[data-modal-close]").dataset.modalClose;this.close(e)}}),document.addEventListener("keydown",t=>{if(t.key==="Escape"){const e=document.querySelector('.modal[style*="display: flex"]');e&&this.close(e.id)}}),document.querySelectorAll(".modal-close").forEach(t=>{t.addEventListener("click",e=>{const r=e.target.closest(".modal");r&&this.close(r.id)})})},open(t){const e=document.getElementById(t);if(e){e.style.display="flex",document.body.classList.add("modal-open");const r=e.querySelector("input, textarea, button");r&&r.focus()}},close(t){const e=document.getElementById(t);e&&(e.style.display="none",document.body.classList.remove("modal-open"))}};c.init();window.ModalManager=c;window.closeModal=c.close.bind(c);window.openModal=c.open.bind(c);const l={show(t,e="success",r=3e3){document.querySelectorAll(".toast").forEach(o=>o.remove());const a=document.createElement("div");a.className=`toast toast-${e}`,a.setAttribute("role","alert"),a.setAttribute("aria-live","assertive"),a.innerHTML=`
        <i class="fas ${e==="success"?"fa-check-circle":"fa-exclamation-circle"}"></i>
        <span>${t}</span>
      `,document.body.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)},r),a.addEventListener("click",()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)})}},d={formatDate(t){if(!t)return"Recently";try{const e=t.toDate?t.toDate():new Date(t);if(isNaN(e.getTime()))return"Invalid date";const a=new Date-e,o=Math.floor(a/1e3),i=Math.floor(o/60),s=Math.floor(i/60),n=Math.floor(s/24);return o<60?"Just now":i<60?`${i} min ago`:s<24?`${s} hour${s===1?"":"s"} ago`:n<7?`${n} day${n===1?"":"s"} ago`:new Intl.DateTimeFormat(navigator.language,{month:"short",day:"numeric",year:n>365?"numeric":void 0}).format(e)}catch(e){return console.error("Date formatting error:",e),"Recently"}},escapeHtml(t){return t?t.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""},debounce(t,e){let r;return(...a)=>{clearTimeout(r),r=setTimeout(()=>t.apply(this,a),e)}},async compressImage(t,e=800,r=.7){return new Promise(a=>{const o=new FileReader;o.onload=i=>{const s=new Image;s.src=i.target.result,s.onload=()=>{const n=document.createElement("canvas"),w=Math.min(e/s.width,1);n.width=s.width*w,n.height=s.height*w,n.getContext("2d").drawImage(s,0,0,n.width,n.height),n.toBlob(M=>a(new File([M],t.name,{type:"image/jpeg"})),"image/jpeg",r)}},o.readAsDataURL(t)})}},p={async getUserData(t,e=0){try{const o=await $(y(L,`users/${t}`));if(!o.exists()){const i={username:"New User",zone:"",contact:"",gcash:"",photoURL:"https://placehold.co/120",isNewUser:!0,lastUpdated:v()};return await k(y(L,`users/${t}`),i),i}return o.val()}catch(o){if(console.error("Error getting user data:",o),o.code==="PERMISSION_DENIED"){if(e<3)return console.log(`Retrying user data fetch (attempt ${e+1})`),await new Promise(i=>setTimeout(i,1e3*(e+1))),this.getUserData(t,e+1);l.show("Please sign in to access your data","error"),await f(u),window.location.href="login.html"}throw o}},async getMarketplaceItems(t={},e=null,r=10){try{let a=g(U(I,"marketplaceItems"),B("createdAt","desc"),r(r));t.category&&t.category!=="All Items"&&(a=g(a,E("category","==",t.category))),t.userId&&(a=g(a,E("uid","==",t.userId))),e&&(a=g(a,x(e)));const o=await F(a);if(!o||!o.docs)throw new Error("Invalid snapshot returned");return{items:o.docs.map(i=>{const s=i.data();return{id:i.id,title:s.title||"Untitled",price:s.price||0,images:s.images||[],isSelling:s.isSelling||!1,createdAt:s.createdAt||v(),views:s.views||0,category:s.category||"Other"}}),lastDoc:o.docs[o.docs.length-1]||null}}catch(a){throw console.error("Database Error:",a),new Error("Failed to load marketplace items. Please try again later.")}},async uploadImage(t,e,r=!0){try{const a=r?await d.compressImage(t):t,o=q(V,`${e}/${Date.now()}_${a.name}`);return await z(o,a),_(o)}catch(a){throw console.error("Error uploading image:",a),a}}},b={MAX_RETRIES:3,RETRY_DELAY:1e3,async initialize(){return new Promise((t,e)=>{R(u,async r=>{try{await this.handleAuthState(r),t()}catch(a){e(a)}},r=>{console.error("Auth state observer error:",r),e(r)})})},async handleAuthState(t,e=0){try{if(!t){window.location.href="login.html";return}t.emailVerified||(await T(t),l.show("Verification email sent. Please verify your email.","info"));const r=await p.getUserData(t.uid);r!=null&&r.isNewUser&&setTimeout(()=>c.open("welcomeModal"),1e3),typeof h.loadProfile=="function"&&await h.loadProfile()}catch(r){if(console.error("Auth state error:",r),r.code==="PERMISSION_DENIED"){if(e<this.MAX_RETRIES)return console.log(`Retrying auth state (attempt ${e+1})`),await new Promise(a=>setTimeout(a,this.RETRY_DELAY*(e+1))),this.handleAuthState(t,e+1);l.show("Session expired. Please login again.","error"),await f(u),window.location.href="login.html"}else throw r}}},D={lastVisibleDoc:null,currentCategory:"All Items",isLoading:!1,hasMoreItems:!0,init(){this.setupEventListeners(),this.loadListings()},setupEventListeners(){document.querySelectorAll(".category-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".category-btn").forEach(r=>r.classList.remove("active")),e.classList.add("active"),this.currentCategory=e.dataset.category,this.loadListings()})});const t=document.getElementById("tradeOrSell");t&&t.addEventListener("change",()=>{const e=document.getElementById("priceInput");e&&(e.style.display=t.checked?"block":"none",document.getElementById("itemPrice").required=t.checked)}),window.addEventListener("scroll",d.debounce(()=>{if(this.isLoading||!this.hasMoreItems)return;const{scrollTop:e,scrollHeight:r,clientHeight:a}=document.documentElement;e+a>=r-100&&this.loadListings(!0)},200))},async loadListings(t=!1){if(this.isLoading)return;this.isLoading=!0;const e=document.getElementById("marketplaceListings");try{if(!t)this.lastVisibleDoc=null,this.hasMoreItems=!0,e.innerHTML=`
            <div class="loading-spinner" aria-live="polite">
              <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> 
              Loading listings...
            </div>
          `;else{const o=document.createElement("div");o.className="loading-spinner",o.innerHTML='<i class="fas fa-spinner fa-spin" aria-hidden="true"></i> Loading more...',e.appendChild(o)}const{items:r,lastDoc:a}=await p.getMarketplaceItems({category:this.currentCategory},this.lastVisibleDoc);if(this.lastVisibleDoc=a,this.hasMoreItems=r.length>0,r.length===0&&!t){e.innerHTML=`
            <div class="no-listings" aria-live="polite">
              <i class="fas fa-box-open" aria-hidden="true"></i>
              <p>No listings found in this category</p>
            </div>
          `;return}this.renderListings(r,t)}catch(r){console.error("Error loading listings:",r),l.show("Failed to load listings","error"),t||(e.innerHTML=`
            <div class="error-state" aria-live="polite">
              <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
              <p>Failed to load listings. Please try again.</p>
              <button onclick="MarketplaceManager.loadListings()">Retry</button>
            </div>
          `)}finally{document.querySelectorAll(".loading-spinner").forEach(r=>r.remove()),this.isLoading=!1}},renderListings(t,e=!1){const r=document.getElementById("marketplaceListings");e||(r.innerHTML=""),t.forEach(a=>{const o=document.createElement("div");o.className="product-card",o.dataset.id=a.id,o.setAttribute("role","article"),o.tabIndex=0,o.innerHTML=`
          <span class="product-badge ${a.isSelling?"":"trade"}" aria-label="${a.isSelling?"For Sale":"For Trade"}">
            ${a.isSelling?"For Sale":"For Trade"}
          </span>
          <img src="${a.images[0]||"https://placehold.co/250"}" 
               alt="${d.escapeHtml(a.title)}" 
               loading="lazy"
               onerror="this.src='https://placehold.co/250'">
          <div class="product-info">
            <h3>${d.escapeHtml(a.title)}</h3>
            <div class="price">${a.isSelling?`₱${a.price.toFixed(2)}`:"Trade Only"}</div>
            <div class="location">
              <i class="fas fa-map-marker-alt" aria-hidden="true"></i> Bulihan, Silang, Cavite
            </div>
            <div class="product-meta">
              <span>${d.formatDate(a.createdAt)}</span>
              <span><i class="fas fa-eye" aria-hidden="true"></i> ${a.views||0}</span>
            </div>
          </div>
        `,o.addEventListener("click",()=>{this.viewListingDetails(a)}),o.addEventListener("keydown",i=>{(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),this.viewListingDetails(a))}),r.appendChild(o)})},viewListingDetails(t){console.log("Viewing listing:",t)}},h={async loadProfile(){const t=u.currentUser;if(t)try{const e=await p.getUserData(t.uid);if(!e)return;const r={userName:e.username||"User",userEmail:t.email||"No email",userZone:e.zone||"No zone",userAvatar:e.photoURL||"https://placehold.co/40",nicknameInput:e.username||"",zoneSelect:e.zone||"",contactInput:e.contact||"",gcashInput:e.gcash||"",previewImg:e.photoURL||"https://placehold.co/120"};Object.entries(r).forEach(([a,o])=>{const i=document.getElementById(a);i&&(a.endsWith("Avatar")||a.endsWith("Img")?i.src=o:(i.textContent=o,i.value=o))}),e.isNewUser&&setTimeout(()=>c.open("welcomeModal"),1e3)}catch(e){console.error("Error loading profile:",e),l.show("Error loading profile data","error")}}};document.addEventListener("DOMContentLoaded",async function(){try{await b.initialize(),c.init(),document.getElementById("marketplaceListings")&&D.init(),document.getElementById("userAvatar")&&h.loadProfile();try{await O(I,{forceOwnership:!0}),console.log("Offline persistence enabled")}catch(t){t.code==="failed-precondition"?console.warn("Offline persistence already enabled in another tab"):t.code==="unimplemented"&&console.warn("Offline persistence not supported in this browser")}}catch(t){console.error("Initialization error:",t),l.show("Failed to initialize app. Please refresh.","error")}});window.logout=async function(){try{await f(u),window.location.href="login.html"}catch(t){console.error("Logout failed:",t),l.show("Failed to logout. Please try again.","error")}};window.MarketplaceManager=D;window.AuthManager=b;
