import{initializeApp as A}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";import{getAuth as D,signOut as h,sendEmailVerification as M,onAuthStateChanged as T}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";import{getDatabase as R,get as $,ref as y,set as k}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";import{getFirestore as B,enableIndexedDbPersistence as P,query as u,collection as x,orderBy as N,where as w,startAfter as O,getDocs as q,serverTimestamp as v}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";import{getStorage as F,ref as U,uploadBytes as H,getDownloadURL as _}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function o(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=o(i);fetch(i.href,s)}})();const C={apiKey:"AIzaSyCxaOGeOvHwS5dnPHRTpw3Lwn2surjXP1E",authDomain:"tradeconnect-3c728.firebaseapp.com",projectId:"tradeconnect-3c728",storageBucket:"tradeconnect-3c728.appspot.com",messagingSenderId:"299665603548",appId:"1:299665603548:web:9ff10af44cd41605382d19",databaseURL:"https://tradeconnect-3c728-default-rtdb.asia-southeast1.firebasedatabase.app"},m=A(C),g=D(m),L=B(m),V=F(m),E=R(m),l={init(){document.addEventListener("click",t=>{if(t.target.classList.contains("modal")&&this.close(t.target.id),t.target.classList.contains("close")){const e=t.target.closest(".modal");e&&this.close(e.id)}}),document.addEventListener("keydown",t=>{if(t.key==="Escape"){const e=document.querySelector('.modal[style*="display: flex"]');e&&this.close(e.id)}})},open(t){const e=document.getElementById(t);if(e){e.style.display="flex",document.body.classList.add("modal-open");const o=e.querySelector("input, textarea, button");o&&o.focus()}},close(t){const e=document.getElementById(t);e&&(e.style.display="none",document.body.classList.remove("modal-open"))}},c={show(t,e="success",o=3e3){document.querySelectorAll(".toast").forEach(i=>i.remove());const a=document.createElement("div");a.className=`toast toast-${e}`,a.setAttribute("role","alert"),a.setAttribute("aria-live","assertive"),a.innerHTML=`
        <i class="fas ${e==="success"?"fa-check-circle":e==="error"?"fa-exclamation-circle":"fa-info-circle"}"></i>
        <span>${t}</span>
      `,document.body.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)},o),a.addEventListener("click",()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)})}},d={formatDate(t){if(!t)return"Recently";try{const e=t.toDate?t.toDate():new Date(t);if(isNaN(e.getTime()))return"Recently";const a=new Date-e,i=Math.floor(a/1e3),s=Math.floor(i/60),r=Math.floor(s/60),n=Math.floor(r/24);return i<60?"Just now":s<60?`${s} min ago`:r<24?`${r} hour${r===1?"":"s"} ago`:n<7?`${n} day${n===1?"":"s"} ago`:new Intl.DateTimeFormat(navigator.language,{month:"short",day:"numeric",year:n>365?"numeric":void 0}).format(e)}catch(e){return console.error("Date formatting error:",e),"Recently"}},escapeHtml(t){return t?t.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""},debounce(t,e){let o;return(...a)=>{clearTimeout(o),o=setTimeout(()=>t.apply(this,a),e)}},async compressImage(t,e=800,o=.7){return new Promise(a=>{const i=new FileReader;i.onload=s=>{const r=new Image;r.src=s.target.result,r.onload=()=>{const n=document.createElement("canvas"),p=Math.min(e/r.width,1);n.width=r.width*p,n.height=r.height*p,n.getContext("2d").drawImage(r,0,0,n.width,n.height),n.toBlob(S=>a(new File([S],t.name,{type:"image/jpeg"})),"image/jpeg",o)}},i.readAsDataURL(t)})}},f={async getUserData(t,e=0){try{const i=await $(y(E,`users/${t}`));if(!i.exists()){const s={username:"New User",zone:"",contact:"",gcash:"",photoURL:"https://placehold.co/120",isNewUser:!0,lastUpdated:v()};return await k(y(E,`users/${t}`),s),s}return i.val()}catch(i){if(console.error("Error getting user data:",i),i.code==="PERMISSION_DENIED")return c.show("Please sign in to access your data","error"),await h(g),window.location.href="login.html",null;if(e<3)return console.log(`Retrying user data fetch (attempt ${e+1})`),await new Promise(s=>setTimeout(s,1e3*(e+1))),this.getUserData(t,e+1);throw i}},async getMarketplaceItems(t={},e=null,o=10){try{let a=u(x(L,"marketplaceItems"),N("createdAt","desc"),o(o));t.category&&t.category!=="All Items"&&(a=u(a,w("category","==",t.category))),t.userId&&(a=u(a,w("uid","==",t.userId))),e&&(a=u(a,O(e)));const i=await q(a);if(!i||!i.docs)throw new Error("Invalid snapshot returned");return{items:i.docs.map(s=>{const r=s.data();return{id:s.id,title:r.title||"Untitled",price:r.price||0,images:r.images||[],isSelling:r.isSelling||!1,createdAt:r.createdAt||v(),views:r.views||0,category:r.category||"Other"}}),lastDoc:i.docs[i.docs.length-1]||null}}catch(a){throw console.error("Database Error:",a),new Error("Failed to load marketplace items. Please try again later.")}},async uploadImage(t,e,o=!0){try{const a=o?await d.compressImage(t):t,i=U(V,`${e}/${Date.now()}_${a.name}`);return await H(i,a),_(i)}catch(a){throw console.error("Error uploading image:",a),a}}},I={MAX_RETRIES:3,RETRY_DELAY:1e3,async initialize(){return new Promise((t,e)=>{T(g,async o=>{try{await this.handleAuthState(o),t()}catch(a){e(a)}},o=>{console.error("Auth state observer error:",o),e(o)})})},async handleAuthState(t,e=0){try{if(!t){window.location.href="login.html";return}t.emailVerified||(await M(t),c.show("Verification email sent. Please verify your email.","info"));const o=await f.getUserData(t.uid);if(!o)return;o!=null&&o.isNewUser&&setTimeout(()=>l.open("welcomeModal"),1e3),document.getElementById("userName")&&(document.getElementById("userName").textContent=o.username||"User",document.getElementById("userEmail").textContent=t.email||"",document.getElementById("userAvatar").src=o.photoURL||"https://placehold.co/40")}catch(o){if(console.error("Auth state error:",o),o.code==="PERMISSION_DENIED"){c.show("Session expired. Please login again.","error"),await h(g),window.location.href="login.html";return}if(e<this.MAX_RETRIES)return console.log(`Retrying auth state (attempt ${e+1})`),await new Promise(a=>setTimeout(a,this.RETRY_DELAY*(e+1))),this.handleAuthState(t,e+1);c.show("Failed to authenticate. Please refresh the page.","error")}}},b={lastVisibleDoc:null,currentCategory:"All Items",isLoading:!1,hasMoreItems:!0,init(){this.setupEventListeners(),this.loadListings()},setupEventListeners(){document.querySelectorAll(".category").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".category").forEach(o=>o.classList.remove("active")),e.classList.add("active"),this.currentCategory=e.textContent,this.loadListings()})});const t=document.getElementById("tradeOrSell");t&&t.addEventListener("change",()=>{const e=document.getElementById("priceInput");e&&(e.style.display=t.checked?"block":"none",document.getElementById("itemPrice").required=t.checked)}),window.addEventListener("scroll",d.debounce(()=>{if(this.isLoading||!this.hasMoreItems)return;const{scrollTop:e,scrollHeight:o,clientHeight:a}=document.documentElement;e+a>=o-100&&this.loadListings(!0)},200))},async loadListings(t=!1){if(this.isLoading)return;this.isLoading=!0;const e=document.getElementById("marketplaceListings")||document.getElementById("homeListings");if(!e){this.isLoading=!1;return}try{if(!t)this.lastVisibleDoc=null,this.hasMoreItems=!0,e.innerHTML=`
            <div class="loading-spinner" aria-live="polite">
              <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> 
              Loading listings...
            </div>
          `;else{const i=document.createElement("div");i.className="loading-spinner",i.innerHTML='<i class="fas fa-spinner fa-spin" aria-hidden="true"></i> Loading more...',e.appendChild(i)}const{items:o,lastDoc:a}=await f.getMarketplaceItems({category:this.currentCategory},this.lastVisibleDoc);if(this.lastVisibleDoc=a,this.hasMoreItems=o.length>0,o.length===0&&!t){e.innerHTML=`
            <div class="no-listings" aria-live="polite">
              <i class="fas fa-box-open" aria-hidden="true"></i>
              <p>No listings found in this category</p>
            </div>
          `;return}this.renderListings(o,t,e)}catch(o){console.error("Error loading listings:",o),c.show("Failed to load listings","error"),t||(e.innerHTML=`
            <div class="error-state" aria-live="polite">
              <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
              <p>Failed to load listings. Please try again.</p>
              <button onclick="window.MarketplaceManager.loadListings()">Retry</button>
            </div>
          `)}finally{document.querySelectorAll(".loading-spinner").forEach(o=>o.remove()),this.isLoading=!1}},renderListings(t,e=!1,o){o||(o=document.getElementById("marketplaceListings")||document.getElementById("homeListings")),o&&(e||(o.innerHTML=""),t.forEach(a=>{const i=document.createElement("div");i.className="product-card",i.dataset.id=a.id,i.setAttribute("role","article"),i.tabIndex=0,i.innerHTML=`
          <span class="product-badge ${a.isSelling?"":"trade"}" aria-label="${a.isSelling?"For Sale":"For Trade"}">
            ${a.isSelling?"For Sale":"For Trade"}
          </span>
          <img src="${a.images[0]||"https://placehold.co/250"}" 
               alt="${d.escapeHtml(a.title)}" 
               loading="lazy"
               onerror="this.src='https://placehold.co/250'">
          <div class="product-info">
            <h3>${d.escapeHtml(a.title)}</h3>
            <div class="price">${a.isSelling?`â‚±${a.price.toFixed(2)}`:"Trade Only"}</div>
            <div class="location">
              <i class="fas fa-map-marker-alt" aria-hidden="true"></i> Bulihan, Silang, Cavite
            </div>
            <div class="product-meta">
              <span>${d.formatDate(a.createdAt)}</span>
              <span><i class="fas fa-eye" aria-hidden="true"></i> ${a.views||0}</span>
            </div>
          </div>
        `,i.addEventListener("click",()=>{this.viewListingDetails(a)}),i.addEventListener("keydown",s=>{(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),this.viewListingDetails(a))}),o.appendChild(i)}))},viewListingDetails(t){console.log("Viewing listing:",t),c.show(`Viewing: ${t.title}`,"info")}};document.addEventListener("DOMContentLoaded",async function(){try{await I.initialize(),l.init(),(document.getElementById("marketplaceListings")||document.getElementById("homeListings"))&&b.init(),document.querySelectorAll(".nav-link").forEach(e=>{e.addEventListener("click",function(){const o=this.dataset.target;document.querySelectorAll(".content-section").forEach(a=>{a.classList.remove("active")}),document.querySelectorAll(".nav-link").forEach(a=>{a.classList.remove("active")}),this.classList.add("active"),document.getElementById(o).classList.add("active")})});const t=document.querySelector(".floating-post-btn");t&&t.addEventListener("click",()=>{l.open("addPostModal")}),document.querySelectorAll(".image-upload-input").forEach(e=>{e.addEventListener("change",function(o){const a=o.target.files[0];if(!a)return;const i=this.closest(".image-upload-box").querySelector(".image-preview"),s=new FileReader;s.onload=function(r){i.src=r.target.result,i.style.display="block",i.closest(".image-upload-box").querySelector(".image-upload-text").style.display="none"},s.readAsDataURL(a)})});try{await P(L),console.log("Offline persistence enabled")}catch(e){e.code==="failed-precondition"?console.warn("Offline persistence already enabled in another tab"):e.code==="unimplemented"&&console.warn("Offline persistence not supported in this browser")}}catch(t){console.error("Initialization error:",t),c.show("Failed to initialize app. Please refresh.","error")}});window.closeModal=l.close.bind(l);window.openModal=l.open.bind(l);window.logout=async function(){try{await h(g),window.location.href="login.html"}catch(t){console.error("Logout failed:",t),c.show("Failed to logout. Please try again.","error")}};window.startTour=function(){c.show("Tour started!","info"),closeModal("welcomeModal")};window.MarketplaceManager=b;window.AuthManager=I;window.DatabaseService=f;
