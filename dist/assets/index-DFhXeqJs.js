import{initializeApp as D}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";import{getAuth as S,sendEmailVerification as P,createUserWithEmailAndPassword as $,signOut as H,deleteUser as F}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";import{getDatabase as x,remove as U,ref as w,update as R,get as N}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";import{getFirestore as q,setDoc as O,doc as z,addDoc as b,collection as f,serverTimestamp as v,query as h,where as B,orderBy as V,startAfter as j,getDocs as T,enableIndexedDbPersistence as G}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";import{getStorage as _,uploadBytes as W,getDownloadURL as Z}from"https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();const J={apiKey:"AIzaSyCxaOGeOvHwS5dnPHRTpw3Lwn2surjXP1E",authDomain:"tradeconnect-3c728.firebaseapp.com",projectId:"tradeconnect-3c728",storageBucket:"tradeconnect-3c728.appspot.com",messagingSenderId:"299665603548",appId:"1:299665603548:web:9ff10af44cd41605382d19",databaseURL:"https://tradeconnect-3c728-default-rtdb.firebaseio.com"},L=D(J),p=S(L),u=q(L),K=_(L),C=x(L),I={init(){document.addEventListener("click",t=>{if(t.target.classList.contains("modal")&&this.close(t.target.id),t.target.closest("[data-modal-close]")){const e=t.target.closest("[data-modal-close]").dataset.modalClose;this.close(e)}}),document.addEventListener("keydown",t=>{if(t.key==="Escape"){const e=document.querySelector('.modal[style*="display: flex"]');e&&this.close(e.id)}})},open(t){const e=document.getElementById(t);if(e){e.style.display="flex",document.body.classList.add("modal-open");const s=e.querySelector("input, textarea, button");s&&s.focus()}},close(t){const e=document.getElementById(t);e&&(e.style.display="none",document.body.classList.remove("modal-open"))}},l={show(t,e="success",s=3e3){document.querySelectorAll(".toast").forEach(n=>n.remove());const a=document.createElement("div");a.className=`toast toast-${e}`,a.setAttribute("role","alert"),a.setAttribute("aria-live","assertive"),a.innerHTML=`
      <i class="fas ${e==="success"?"fa-check-circle":"fa-exclamation-circle"}"></i>
      <span>${t}</span>
    `,document.body.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)},s),a.addEventListener("click",()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)})}},c={formatDate(t){if(!t)return"Recently";try{const e=t.toDate?t.toDate():new Date(t);if(isNaN(e.getTime()))return"Invalid date";const a=new Date-e,n=Math.floor(a/1e3),r=Math.floor(n/60),o=Math.floor(r/60),i=Math.floor(o/24);return n<60?"Just now":r<60?`${r} min ago`:o<24?`${o} hour${o===1?"":"s"} ago`:i<7?`${i} day${i===1?"":"s"} ago`:new Intl.DateTimeFormat(navigator.language,{month:"short",day:"numeric",year:i>365?"numeric":void 0}).format(e)}catch(e){return console.error("Date formatting error:",e),"Recently"}},escapeHtml(t){return t?t.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""},getCurrentTime(){return new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},debounce(t,e){let s;return(...a)=>{clearTimeout(s),s=setTimeout(()=>t.apply(this,a),e)}},async compressImage(t,e=800,s=.7){return new Promise(a=>{const n=new FileReader;n.onload=r=>{const o=new Image;o.src=r.target.result,o.onload=()=>{const i=document.createElement("canvas"),d=Math.min(e/o.width,1);i.width=o.width*d,i.height=o.height*d,i.getContext("2d").drawImage(o,0,0,i.width,i.height),i.toBlob(y=>a(new File([y],t.name,{type:"image/jpeg"})),"image/jpeg",s)}},n.readAsDataURL(t)})}},m={lastReportTimes:{},async getUserData(t){try{const e=await N(w(C,`users/${t}`));return e.exists()?e.val():null}catch(e){throw console.error("Error getting user data:",e),e}},async updateUserData(t,e){try{return await R(w(C,`users/${t}`),{...e,lastUpdated:v()}),!0}catch(s){throw console.error("Error updating user data:",s),s}},async reportUser(t,e,s){const a=Date.now(),n=this.lastReportTimes[t]||0;if(a-n<24*60*60*1e3)throw new Error("You can only submit one report per day.");try{return await b(f(u,"reports"),{reporterId:t,reportedId:e,reason:s,timestamp:v(),status:"pending"}),this.lastReportTimes[t]=a,!0}catch(r){throw console.error("Error submitting report:",r),r}},async getForumPosts(t={}){try{let e=f(u,"forumPosts");return t.type&&t.type!=="all"&&(e=h(e,B("type","==",t.type))),(await T(e)).docs.map(a=>({id:a.id,...a.data()}))}catch(e){throw console.error("Error getting forum posts:",e),e}},async createForumPost(t){try{return(await b(f(u,"forumPosts"),{...t,createdAt:v(),likes:0,comments:0,status:"active"})).id}catch(e){throw console.error("Error creating forum post:",e),e}},async uploadImage(t,e,s=!0){try{const a=s?await c.compressImage(t):t,n=w(K,`${e}/${Date.now()}_${a.name}`);return await W(n,a),Z(n)}catch(a){throw console.error("Error uploading image:",a),a}},async getMarketplaceItems(t={},e=null,s=10){try{let a=f(u,"marketplaceItems");t.category&&t.category!=="All Items"&&(a=h(a,B("category","==",t.category))),t.userId&&(a=h(a,B("uid","==",t.userId))),a=h(a,V("createdAt","desc"),s(s)),e&&(a=h(a,j(e)));const n=await T(a);return{items:n.docs.map(r=>({id:r.id,...r.data()})),lastDoc:n.docs[n.docs.length-1]||null}}catch(a){throw console.error("Error getting marketplace items:",a),a}},async createMarketplaceItem(t){try{return(await b(f(u,"marketplaceItems"),{...t,createdAt:v(),views:0})).id}catch(e){throw console.error("Error creating marketplace item:",e),e}}},Y={init(){document.querySelectorAll(".image-upload-box").forEach(t=>{const e=t.querySelector('input[type="file"]'),s=t.querySelector(".image-preview"),a=t.querySelector(".image-upload-text");!e||!s||!a||(e.addEventListener("change",n=>this.handleFileSelect(n,s,a,t)),t.addEventListener("dragover",n=>{n.preventDefault(),t.style.borderColor="var(--primary)",t.style.backgroundColor="rgba(110, 142, 251, 0.1)"}),t.addEventListener("dragleave",()=>{t.style.borderColor="",t.style.backgroundColor=""}),t.addEventListener("drop",n=>{if(n.preventDefault(),t.style.borderColor="",t.style.backgroundColor="",n.dataTransfer.files.length){e.files=n.dataTransfer.files;const r=new Event("change");e.dispatchEvent(r)}}))})},handleFileSelect(t,e,s,a){if(t.target.files&&t.target.files[0]){const n=t.target.files[0];if(!["image/jpeg","image/png","image/webp"].includes(n.type)){l.show("Invalid file type. Only JPEG, PNG, and WebP are allowed.","error");return}if(n.size>5*1024*1024){l.show("File too large. Maximum size is 5MB.","error");return}const o=new FileReader;o.onload=i=>{e.src=i.target.result,e.style.display="block",s.style.display="none",this.addRemoveButton(a,e,s,t.target)},o.readAsDataURL(n)}},addRemoveButton(t,e,s,a){const n=t.querySelector(".remove-image");n&&n.remove();const r=document.createElement("button");r.className="remove-image",r.innerHTML="&times;",r.setAttribute("aria-label","Remove image"),r.style.cssText=`
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    `,r.addEventListener("click",o=>{o.stopPropagation(),e.src="",e.style.display="none",s.style.display="flex",a.value="",r.remove()}),t.appendChild(r)}},X={validate(t){const e=document.getElementById(t);if(!e)return!1;const s=e.querySelectorAll("[required]");let a=!0;return s.forEach(n=>{n.value.trim()?(this.clearError(n),n.type==="email"&&!this.validateEmail(n.value)&&(this.showError(n,"Please enter a valid email"),a=!1),n.type==="password"&&n.value.length<6&&(this.showError(n,"Password must be at least 6 characters"),a=!1)):(this.showError(n,"This field is required"),a=!1)}),a},validateEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)},showError(t,e){if(t.style.borderColor="var(--accent)",!t.nextElementSibling||!t.nextElementSibling.classList.contains("error-message")){const s=document.createElement("div");s.className="error-message",s.textContent=e,s.style.cssText=`
        color: var(--accent);
        font-size: 12px;
        margin-top: 5px;
      `,t.after(s)}},clearError(t){t.style.borderColor="",t.nextElementSibling&&t.nextElementSibling.classList.contains("error-message")&&t.nextElementSibling.remove()}},Q={lastVisibleDoc:null,currentCategory:"All Items",isLoading:!1,init(){this.setupEventListeners(),this.loadListings()},setupEventListeners(){document.querySelectorAll(".category-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".category-btn").forEach(s=>s.classList.remove("active")),e.classList.add("active"),this.currentCategory=e.dataset.category,this.loadListings()})});const t=document.getElementById("tradeOrSell");t&&t.addEventListener("change",()=>{const e=document.getElementById("priceInput");e&&(e.style.display=t.checked?"block":"none",document.getElementById("itemPrice").required=t.checked)}),this.initInfiniteScroll()},initInfiniteScroll(){const t=new IntersectionObserver(s=>{s[0].isIntersecting&&this.lastVisibleDoc&&!this.isLoading&&this.loadMoreListings()},{threshold:.1}),e=document.createElement("div");e.id="scrollSentinel",document.getElementById("marketplaceListings").appendChild(e),t.observe(e)},async loadListings(t=!1){if(this.isLoading)return;this.isLoading=!0;const e=document.getElementById("marketplaceListings");try{t||(this.lastVisibleDoc=null,e.innerHTML=`
          <div class="loading-spinner" aria-live="polite">
            <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> 
            Loading listings...
          </div>
        `);const{items:s,lastDoc:a}=await m.getMarketplaceItems({category:this.currentCategory},this.lastVisibleDoc);if(this.lastVisibleDoc=a,s.length===0&&!t){e.innerHTML=`
          <div class="no-listings" aria-live="polite">
            <i class="fas fa-box-open" aria-hidden="true"></i>
            <p>No listings found in this category</p>
          </div>
        `;return}this.renderListings(s,t),this.updateLoadMoreButton(!!a)}catch(s){console.error("Error loading listings:",s),l.show("Failed to load listings","error")}finally{this.isLoading=!1}},async loadMoreListings(){await this.loadListings(!0)},renderListings(t,e=!1){const s=document.getElementById("marketplaceListings");e||(s.innerHTML=""),t.forEach(a=>{const n=document.createElement("div");n.className="product-card",n.dataset.id=a.id,n.setAttribute("role","article"),n.innerHTML=`
        <span class="product-badge ${a.isSelling?"":"trade"}" aria-label="${a.isSelling?"For Sale":"For Trade"}">
          ${a.isSelling?"For Sale":"For Trade"}
        </span>
        <img src="${a.images[0]||"https://via.placeholder.com/250"}" 
             alt="${c.escapeHtml(a.title)}" 
             loading="lazy"
             onerror="this.src='https://via.placeholder.com/250'">
        <div class="product-info">
          <h3>${c.escapeHtml(a.title)}</h3>
          <div class="price">${a.isSelling?`₱${a.price.toFixed(2)}`:"Trade Only"}</div>
          <div class="location">
            <i class="fas fa-map-marker-alt" aria-hidden="true"></i> Bulihan, Silang, Cavite
          </div>
          <div class="product-meta">
            <span>${c.formatDate(a.createdAt)}</span>
            <span><i class="fas fa-eye" aria-hidden="true"></i> ${a.views||0}</span>
          </div>
        </div>
      `,n.addEventListener("click",()=>{this.viewListingDetails(a)}),n.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),this.viewListingDetails(a))}),n.tabIndex=0,s.appendChild(n)})},updateLoadMoreButton(t){let e=document.getElementById("loadMoreBtn");t&&!e?(e=document.createElement("button"),e.id="loadMoreBtn",e.className="load-more-btn",e.textContent="Load More",e.addEventListener("click",()=>this.loadMoreListings()),document.getElementById("marketplaceContainer").appendChild(e)):!t&&e&&e.remove()},viewListingDetails(t){console.log("Viewing listing:",t)}},ee={init(){this.setupEventListeners(),this.loadPosts()},setupEventListeners(){const t=document.getElementById("postTypeFilter");t&&t.addEventListener("change",()=>this.loadPosts());const e=document.getElementById("postType");e&&e.addEventListener("change",()=>{const a=document.getElementById("paymentMethodField"),n=document.getElementById("gcashField");a&&n&&(a.style.display=e.value==="scam"||e.value==="review"?"block":"none",n.style.display="none")});const s=document.getElementById("paymentMethod");s&&s.addEventListener("change",()=>{const a=document.getElementById("gcashField");a&&(a.style.display=s.value==="gcash"?"block":"none")})},async loadPosts(){const t=document.getElementById("forumPostsContainer");if(t)try{t.innerHTML=`
        <div class="loading-spinner" aria-live="polite">
          <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> 
          Loading posts...
        </div>
      `;const e=document.getElementById("postTypeFilter"),s=e?e.value:"all",a=await Promise.race([m.getForumPosts({type:s==="all"?null:s}),new Promise((n,r)=>setTimeout(()=>r(new Error("Request timeout")),1e4))]);if(!a||a.length===0){t.innerHTML=`
          <div class="no-posts" aria-live="polite">
            <i class="fas fa-comment-slash" aria-hidden="true"></i>
            <p>No posts found</p>
          </div>
        `;return}t.innerHTML="",a.forEach(n=>{if(!n.id||!n.type||!n.title||!n.content){console.warn("Invalid post data:",n);return}const r=document.createElement("div");r.className="forum-post",r.dataset.id=n.id,r.setAttribute("role","article");const o={review:"✅",scam:"⚠️",question:"💬",buy:"🔎"}[n.type]||"";r.innerHTML=`
          <div class="post-header">
            <span class="post-type">${o} ${n.type.toUpperCase()}</span>
            <span class="post-date">${c.formatDate(n.createdAt)}</span>
          </div>
          <h3 class="post-title">${c.escapeHtml(n.title)}</h3>
          <p class="post-content">${c.escapeHtml(n.content)}</p>
          
          ${n.location?`
            <div class="post-meta">
              <i class="fas fa-map-marker-alt" aria-hidden="true"></i> 
              ${c.escapeHtml(n.location)}
            </div>
          `:""}
          
          ${n.imageUrl?`
            <img src="${c.escapeHtml(n.imageUrl)}" 
                 class="post-image" 
                 alt="Post image" 
                 loading="lazy"
                 onerror="this.style.display='none'">
          `:""}
          
          <div class="post-actions">
            <button class="comment-btn" aria-label="Comment">
              <i class="far fa-comment" aria-hidden="true"></i> 
              Comment (${n.comments||0})
            </button>
            <button class="like-btn" aria-label="Like">
              <i class="far fa-heart" aria-hidden="true"></i> 
              Like (${n.likes||0})
            </button>
          </div>
        `,r.addEventListener("keydown",i=>{(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),this.viewPostDetails(n))}),r.tabIndex=0,t.appendChild(r)})}catch(e){console.error("Error loading forum posts:",e),t.innerHTML=`
        <div class="error-state" aria-live="polite">
          <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
          <p>Failed to load posts. Please try again.</p>
          <button onclick="ForumManager.loadPosts()">Retry</button>
        </div>
      `}},viewPostDetails(t){console.log("Viewing post:",t)}},M={init(){this.setupEventListeners(),this.loadProfile()},setupEventListeners(){const t=document.getElementById("profile-upload");t&&t.addEventListener("change",a=>{const n=document.getElementById("preview-img"),r=document.getElementById("userAvatar");if(n&&r){const o=new FileReader;o.onload=function(){n.src=o.result,r.src=o.result},o.readAsDataURL(a.target.files[0])}});const e=document.querySelector(".save-btn");e&&e.addEventListener("click",()=>this.saveProfile());const s=document.querySelector(".delete-btn");s&&s.addEventListener("click",()=>this.confirmDelete())},async loadProfile(){const t=p.currentUser;if(t)try{const e=await m.getUserData(t.uid);if(!e)return;const s={userName:e.username||"User",userEmail:t.email||"No email",userZone:e.zone||"No zone",userAvatar:e.photoURL||"https://via.placeholder.com/40",nicknameInput:e.username||"",zoneSelect:e.zone||"",contactInput:e.contact||"",gcashInput:e.gcash||"",previewImg:e.photoURL||"https://via.placeholder.com/120"};Object.entries(s).forEach(([a,n])=>{const r=document.getElementById(a);r&&(a.endsWith("Avatar")||a.endsWith("Img")?r.src=n:(r.textContent=n,r.value=n))}),e.isNewUser&&setTimeout(()=>I.open("welcomeModal"),1e3)}catch(e){console.error("Error loading profile:",e),l.show("Error loading profile data","error")}},async saveProfile(){const t=p.currentUser;if(!t)return;const e=document.getElementById("nickname").value,s=document.getElementById("zone").value,a=document.getElementById("contact").value,n=document.getElementById("gcash").value,r=document.getElementById("profile-upload").files[0],o=document.querySelector(".save-btn");if(o)try{o.disabled=!0,o.classList.add("loading"),o.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...';const i={username:e,zone:s,contact:a,gcash:n};if(r){const A=await m.uploadImage(r,`profilePictures/${t.uid}`);i.photoURL=A}await m.updateUserData(t.uid,i);const d=document.getElementById("userName"),g=document.getElementById("userZone"),y=document.getElementById("userAvatar");d&&(d.textContent=e),g&&(g.textContent=s),y&&i.photoURL&&(y.src=i.photoURL),l.show("Profile updated successfully!"),I.close("settingsModal")}catch(i){console.error("Error updating profile:",i),l.show("Failed to update profile. Please try again.","error")}finally{o.disabled=!1,o.classList.remove("loading"),o.innerHTML='<i class="fas fa-save"></i> Save Changes'}},confirmDelete(){confirm("Are you sure you want to DELETE your account? This action cannot be undone.")&&this.deleteAccount()},async deleteAccount(){const t=p.currentUser;if(!t)return;const e=document.querySelector(".delete-btn");if(e)try{e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Deleting...',await U(w(C,`users/${t.uid}`)),await F(t),l.show("Account deleted successfully."),window.location.href="login.html"}catch(s){console.error("Error deleting account:",s),l.show("Failed to delete account. Please try again.","error"),e.disabled=!1,e.innerHTML='<i class="fas fa-trash-alt"></i> Delete Account'}}},te={lastMessageTime:0,MESSAGE_RATE_LIMIT:1e3,init(){this.setupEventListeners()},setupEventListeners(){const t=document.getElementById("sendMessage");t&&t.addEventListener("click",()=>this.sendMessage());const e=document.getElementById("messageInput");e&&e.addEventListener("keydown",s=>{s.key==="Enter"&&this.sendMessage()})},sendMessage(){const t=Date.now();if(t-this.lastMessageTime<this.MESSAGE_RATE_LIMIT){l.show("Please wait before sending another message","warning");return}this.lastMessageTime=t;const e=document.getElementById("messageInput"),s=document.getElementById("chatMessages");if(!e||!s)return;const a=e.value.trim();if(!a){l.show("Message cannot be empty","warning");return}if(a.length>500){l.show("Message is too long (max 500 characters)","warning");return}const n=document.createElement("div");n.className="message sent",n.setAttribute("role","log"),n.setAttribute("aria-live","polite"),n.innerHTML=`
      <div class="message-content">
        <p>${c.escapeHtml(a)}</p>
        <span class="message-time">${c.getCurrentTime()}</span>
      </div>
    `,s.appendChild(n),e.value="",s.scrollTop=s.scrollHeight,setTimeout(()=>{const r=document.createElement("div");r.className="message received",r.setAttribute("role","log"),r.setAttribute("aria-live","polite"),r.innerHTML=`
        <div class="message-content">
          <p>Thanks for your message! Our team will respond shortly.</p>
          <span class="message-time">${c.getCurrentTime()}</span>
        </div>
      `,s.appendChild(r),s.scrollTop=s.scrollHeight},1500)}},ne={init(){this.renderCategories(),this.setupEventListeners()},renderCategories(){const t=document.getElementById("helpCategories");t&&(t.innerHTML="",E.categories.forEach(e=>{const s=document.createElement("div");s.className="category-card",s.dataset.categoryId=e.id,s.setAttribute("role","button"),s.tabIndex=0,s.innerHTML=`
        <i class="${e.icon}" aria-hidden="true"></i>
        <h3>${e.title}</h3>
        <p>${e.description}</p>
      `,t.appendChild(s)}))},setupEventListeners(){document.addEventListener("click",a=>{const n=a.target.closest(".category-card");if(n){const o=n.dataset.categoryId;this.renderArticles(o),document.getElementById("helpArticles").scrollIntoView({behavior:"smooth"})}const r=a.target.closest(".article-card");r&&this.renderArticleDetail(r.dataset.articleId)});const t=document.getElementById("backToList");t&&t.addEventListener("click",()=>{document.getElementById("articleDetail").style.display="none",document.getElementById("helpArticles").style.display="block",document.getElementById("helpCategories").style.display="flex"});const e=document.getElementById("searchHelpBtn");e&&e.addEventListener("click",()=>{const a=document.getElementById("helpSearch").value;this.renderArticles(null,a)});const s=document.getElementById("helpSearch");s&&s.addEventListener("keyup",a=>{if(a.key==="Enter"){const n=document.getElementById("helpSearch").value;this.renderArticles(null,n)}}),document.querySelectorAll(".feedback-btn").forEach(a=>{a.addEventListener("click",()=>{document.getElementById("articleDetail").dataset.articleId;const n=a.dataset.helpful==="yes";l.show(`Thank you for your feedback! Article marked as ${n?"helpful":"not helpful"}`)})})},renderArticles(t=null,e=""){const s=document.getElementById("helpArticles");if(!s)return;s.innerHTML="";let a=E.articles;if(t&&(a=a.filter(n=>n.category===t)),e){const n=e.toLowerCase();a=a.filter(r=>r.title.toLowerCase().includes(n)||r.content.toLowerCase().includes(n))}if(a.length===0){s.innerHTML=`
        <div class="no-articles" aria-live="polite">
          <i class="fas fa-info-circle" aria-hidden="true"></i>
          <p>No articles found</p>
        </div>
      `;return}a.forEach(n=>{const r=document.createElement("div");r.className="article-card",r.dataset.articleId=n.id,r.setAttribute("role","button"),r.tabIndex=0,r.innerHTML=`
        <h3>${n.title}</h3>
        <div class="article-meta">
          <span>${this.getCategoryName(n.category)}</span>
          <span> • ${c.formatDate(n.date)}</span>
        </div>
      `,s.appendChild(r)})},renderArticleDetail(t){const e=E.articles.find(r=>r.id===t);if(!e)return;const s=document.getElementById("helpArticles"),a=document.getElementById("helpCategories"),n=document.getElementById("articleDetail");s&&a&&n&&(s.style.display="none",a.style.display="none",n.style.display="block",document.getElementById("articleTitle").textContent=e.title,document.getElementById("articleCategory").textContent=this.getCategoryName(e.category),document.getElementById("articleDate").textContent=c.formatDate(e.date),document.getElementById("articleContent").innerHTML=e.content)},getCategoryName(t){const e=E.categories.find(s=>s.id===t);return e?e.title:""}};document.addEventListener("DOMContentLoaded",function(){I.init(),Y.init(),document.getElementById("marketplaceListings")&&Q.init(),document.getElementById("forumPostsContainer")&&ee.init(),document.getElementById("userAvatar")&&M.init(),document.getElementById("chatMessages")&&te.init(),document.getElementById("helpCategories")&&ne.init(),p.onAuthStateChanged(async s=>{try{if(s){if(!s.emailVerified&&s.email&&await P(s),!await Promise.race([m.getUserData(s.uid),new Promise((n,r)=>setTimeout(()=>r(new Error("Timeout loading user data")),5e3))])){I.open("signupModal");return}M.loadProfile()}else window.location.href="login.html"}catch(a){console.error("Auth state error:",a),l.show("Error loading user data. Please refresh.","error")}});async function t(){try{await G(u),console.log("Offline persistence enabled")}catch(s){s.code=="failed-precondition"?console.warn("Offline persistence can only be enabled in one tab at a time."):s.code=="unimplemented"&&console.warn("Offline persistence is not supported in this browser.")}}t();function e(){const s={"ES6 Promise":"Promise"in window,"Fetch API":"fetch"in window,IntersectionObserver:"IntersectionObserver"in window,"Web Storage":"localStorage"in window,Internationalization:"Intl"in window},a=Object.entries(s).filter(([n,r])=>!r).map(([n])=>n);if(a.length>0){const n=`Your browser is missing: ${a.join(", ")}. 
        Some features may not work properly. Consider updating your browser.`;l.show(n,"warning",1e4),console.warn("Missing browser features:",a)}}e()});const E={categories:[{id:"getting-started",title:"Getting Started",icon:"fas fa-book",description:"Learn how to begin using TradeConnect"},{id:"trading",title:"Trading Guide",icon:"fas fa-exchange-alt",description:"How to trade items in the marketplace"},{id:"buying-selling",title:"Buying & Selling",icon:"fas fa-money-bill-wave",description:"Guide to buying and selling items"},{id:"messages",title:"Messages",icon:"fas fa-comments",description:"How to use the messaging system"},{id:"community",title:"Community Forum",icon:"fas fa-users",description:"Using the community features"},{id:"account",title:"Account & Settings",icon:"fas fa-cog",description:"Manage your account settings"}],articles:[{id:"what-is-tradeconnect",category:"getting-started",title:"What is TradeConnect?",content:"<p>TradeConnect is a web app that allows users in Barangay Bulihan, Silang, Cavite (Zones 1-11) to trade, buy, and sell items safely and directly.</p>",date:"2023-10-15",helpful:42,notHelpful:3},{id:"how-to-create-account",category:"getting-started",title:"How to create an account?",content:"<p>Go to the registration page, fill in your details, and verify your number to get started.</p>",date:"2023-10-15",helpful:38,notHelpful:2},{id:"how-to-trade",category:"trading",title:"How to trade?",content:'<p>Click on a post with a "Trade" label. It will open a direct chat to negotiate the swap.</p>',date:"2023-10-16",helpful:28,notHelpful:1},{id:"how-to-buy",category:"buying-selling",title:"How to buy items?",content:'<p>Click "Buy" on a listing and proceed directly to payment (GCash or Cash method).</p>',date:"2023-10-17",helpful:35,notHelpful:4}]};var k;(k=document.getElementById("signupForm"))==null||k.addEventListener("submit",async t=>{if(t.preventDefault(),!X.validate("signupForm"))return;const e=document.getElementById("signupName").value,s=document.getElementById("signupEmail").value,a=document.getElementById("signupPassword").value,n=document.getElementById("signupZone").value,r=document.getElementById("signupContact").value,o=document.getElementById("signupPhoto").files[0];try{const d=(await $(p,s,a)).user.uid;let g="";o&&(g=await m.uploadImage(o,`profilePictures/${d}`)),await O(z(u,"users",d),{username:e,email:s,zone:n,contact:r,photoURL:g,isNewUser:!0}),window.location.href="index.html"}catch(i){console.error("Signup failed:",i),l.show(`Signup failed: ${i.message}`,"error")}});window.logout=async function(){try{await H(p),window.location.href="login.html"}catch(t){console.error("Logout failed:",t),l.show("Failed to logout. Please try again.","error")}};
